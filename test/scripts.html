<!DOCTYPE HTML>
<head>
    <title>
        Script Tests &ndash; Mych's Macro Magic
    </title>
    <script>
        eventHandlers = {};

        function on(eventName, eventHandler)
        {
            eventHandlers[eventName] = eventHandler;
        }
    </script>
    <script src="../MychsMacroMagic.js">
    </script>
    <script>
        function escapeHTML(text)
        {
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
    <style type="text/css">
        body {
            font-family: Consolas, monospace;
            font-size: 9pt;
            line-height: 13pt;
        }

        div.script {
            padding: 0.5em 1em 1em 1em;
            border: 1px solid silver;
            margin-bottom: 1em;
            white-space: pre-wrap;
        }

        td {
            vertical-align: top;
            padding: 0;
            margin: 0;
        }

        td.script-header {
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 10pt;
            padding-bottom: 0.5em;
        }

        td.lineno {
            width: 3em;
            color: gray;
            font-family: Calibri, sans-serif;
            text-align: right;
            padding-right: 1em;
        }

        td.output {
            white-space: normal;
        }

        div.sheet-rolltemplate-default table {
            border: 1px solid;
            color: black;
            border-color: rgba(112, 32, 130,1);
            font-size: 1em;
            font-family: "Helvetica Neue", Helvetica, sans-serif;
        }

        div.sheet-rolltemplate-default caption {
            background-color: rgba(112, 32, 130,1);
            color: #ffffff;
            padding: 2px;
            border-bottom: 1px solid black;
            line-height: 1.6em;
            font-size: 1.2em;
        }

        div.sheet-rolltemplate-default td {
            padding: 5px;
        }

        div.sheet-rolltemplate-default td:nth-child(1) {
            font-weight: bold;
        }

        div.sheet-rolltemplate-default tr:nth-child(odd) {
            background-color: rgba(217, 217, 214,1);
        }

        div.sheet-rolltemplate-default tr:nth-child(even) {
            background-color: rgba(233, 233, 233,1);
        }

        span.original {
            color: gray;
            font-family: Calibri, sans-serif;
            font-style: italic;
        }

        span.state {
            color: gray;
            font-family: Calibri, sans-serif;
        }

        span.error {
            color: red;
            font-family: Calibri, sans-serif;
        }
    </style>
</head>
<body>
    <script>
        var includedScriptSources = [];

        var scriptSources =
        [
            [
                "!mmm do chat(version)",
            ],
            [
                "!mmm",
                "!mmm ",
                "!mmm  ",
                "!mmm   ",
                "!mmm    chat: success",
            ],
            [
                "!mmm chat: sender = ${sender}, playerid = ${playerid}, version = ${version}",
            ],
            [
                "!mmm set correct = 123 + 456",
            ],
            [
                "!mmm set missingExpression",
            ],
            [
                "!mmm set incorrectAssignmentOperator := 123 + 456",
            ],
            [
                "!mmm do chat('correct')"
            ],
            [
                "!mmm do chat 'unknown operator'!"
            ],
            [
                "!mmm do chat 'missing parentheses'"
            ],
            [
                "!mmm     unknown command",
            ],
            [
                "!mmm chat: Hello World! Meaning of life: ${6*7}, current AP: ${getattr('Dummy', 'AP')}",
            ],
            [
                "!mmm chat: this <${undefinedValue}> should be empty",
            ],
            [
                "!mmm chat:  11 %  8 = ${ 11 %  8} (3 expected)",
                "!mmm chat: -11 %  8 = ${-11 %  8} (5 expected)",
                "!mmm chat:  11 % -8 = ${ 11 % -8} (-5 expected)",
                "!mmm chat: -11 % -8 = ${-11 % -8} (-3 expected)",
            ],
            [
                "!mmm chat: floor(.) = (-1.2) = ${floor(-1.2)}, (-1.5) = ${floor(-1.5)}, (-1.7) = ${floor(-1.7)}, (1.2) = ${floor(1.2)}, (1.5) = ${floor(1.5)}, (1.7) = ${floor(1.7)}",
                "!mmm chat: round(.) = (-1.2) = ${round(-1.2)}, (-1.5) = ${round(-1.5)}, (-1.7) = ${round(-1.7)}, (1.2) = ${round(1.2)}, (1.5) = ${round(1.5)}, (1.7) = ${round(1.7)}",
                "!mmm chat: ceil(.) = (-1.2) = ${ceil(-1.2)}, (-1.5) = ${ceil(-1.5)}, (-1.7) = ${ceil(-1.7)}, (1.2) = ${ceil(1.2)}, (1.5) = ${ceil(1.5)}, (1.7) = ${ceil(1.7)}",
                "!mmm chat: abs(.) = (-1.2) = ${abs(-1.2)}, (-1.5) = ${abs(-1.5)}, (-1.7) = ${abs(-1.7)}, (1.2) = ${abs(1.2)}, (1.5) = ${abs(1.5)}, (1.7) = ${abs(1.7)}",
            ],
            [
                "!mmm chat: min() = <${min()}>, min(+123, undef) = ${min(+123, undef)}, min(.) = ${min(5, undefined, 'moo', 999, 2, -3.14)}",
                "!mmm chat: max() = <${max()}>, min(-456, undef) = ${min(-456, undef)}, max(.) = ${max(5, undefined, 'moo', 999, 2, -3.14)}",
            ],
            [
                "!mmm chat: ${1 + ?}",
                "!mmm chat: ${1 + ? ? 2}",
                "!mmm chat: ${1 + ???? 2}",
                "!mmm chat: ${1 + ? 2 * 3 + 4}",
                "!mmm chat: ${1 + ?? 2 * 3 + 4}",
                "!mmm chat: ${1 + ??? 2 * 3 + 4}",
                "!mmm chat: ${1 + ?(2 * 3) + 4}",
                "!mmm chat: ${1 + ?((2 * 3)) + 4}",
                "!mmm chat: ${1 + ?(2 * 3 + 4)}",
                "!mmm chat: ${1 + ?((2 * 3 + 4))}",
                "!mmm chat: ${1 + ?(2 * 3 + ? 4)}",
                "!mmm chat: ${1 + ?getattr('Dummy', 'AP')}",
                "!mmm chat: ${?('foo' & 123 & 'bar')}",
                "!mmm chat: ${1 + ? 2**3 * 4 <= 5}",
                "!mmm chat: ${1 + ?? 2**3 * 4 <= 5}",
                "!mmm chat: ${1 + ??? 2**3 * 4 <= 5}",
                "!mmm chat: ${? 2**3 * 4 <= 5}",
                "!mmm chat: ${?? 2**3 * 4 <= 5}",
                "!mmm chat: ${??? 2**3 * 4 <= 5}",
            ],
            [
                "!mmm debug do 1 + 2",
                "!mmm script",
                "!mmm     set foo = 42",
                "!mmm     debug do foo",
                "!mmm end script",
                "!mmm debug do getattr('Dummy', 'AP')",
                "!mmm debug do setattr('Dummy', 'AP', getattr('Dummy', 'AP') - 1)"
            ],
            [
                "!mmm debug chat: number is ${3.141}",
                "!mmm debug chat: string is ${'foo' & 'bar'}",
                "!mmm debug chat: bool is ${1 == 2}",
                "!mmm debug chat: undefined is ${undefined}",
                "!mmm debug chat: list is ${1, 2, 3, 'foo', 'bar', 'baz', undefined}",
                "!mmm debug chat: default is ${default}",
                "!mmm debug chat: denied is ${denied}",
                "!mmm debug chat: roll is ${roll('1d6')}",
            ],
            [
                "!mmm chat: this is ${highlight('rather normal')}, ${highlight('rather good', 'good')}, ${highlight('rather bad', 'bad')}, or ${highlight('very important', 'important')} indeed",
                "!mmm chat: but hover ${highlight('this', 'normal', 'fancy tooltip')} for a tooltip",
            ],
            [
                "!mmm else",
            ],
            [
                "!mmm if true",
                "!mmm else",
                "!mmm else",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm else if broken syntax in expression",
                "!mmm end if",
            ],
            [
                "!mmm if true",
                "!mmm    chat: correct[1/1]",
                "!mmm else if true",
                "!mmm    chat: broken",
                "!mmm else",
                "!mmm    chat: broken",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm    chat: broken",
                "!mmm else if true",
                "!mmm    chat: correct[1/1]",
                "!mmm else",
                "!mmm    chat: broken",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm    chat: broken",
                "!mmm else if false",
                "!mmm    chat: broken",
                "!mmm else",
                "!mmm    chat: correct[1/1]",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm    if true",
                "!mmm        chat: broken",
                "!mmm    end if",
                "!mmm else",
                "!mmm    chat: correct[1/1]",
                "!mmm end if",
            ],
            [
                "!mmm chat: foo",
                "!mmm chat: bar",
            ],
            [
                "!mmm set discardedVariable = 123 + 456",
                "!mmm chat: discardedVariable=${discardedVariable}",
            ],
            [
                "!mmm script",
                "!mmm     set retainedVariable = 123 + 456",
                "!mmm     chat: retainedVariable=${retainedVariable}",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     chat: broken",
                "!mmm script",
                "!mmm     chat: correct[1/1]",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm    end script syntax error",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm    chat: broken",
                "!mmm    if true",
                "!mmm        syntax error",
                "!mmm    end if",
                "!mmm end script",
                "!mmm chat: correct[1/1]",
            ],
            [
                "!mmm script",
                "!mmm    chat: broken",
                "!mmm    if true",
                "!mmm end script",
                "!mmm chat: correct[1/1]",
            ],
            [
                "!mmm parse error",
                "!mmm script",
                "!mmm    chat: correct[1/2]",
                "!mmm end script",
                "!mmm chat: correct[2/2]",
            ],
            [
                "!mmm parse error",
                "!mmm combine chat",
                "!mmm    chat: correct[1/2]",
                "!mmm end combine",
                "!mmm chat: correct[2/2]",
            ],
            [
                "!mmm status",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: broken",
                "!mmm status",
            ],
            [
                "!mmm script",
                "!mmm     set foo = 1",
                "!mmm     if true",
                "!mmm         chat: True dat!",
                "!mmm     else",
                "!mmm         combine chat",
                "!mmm             if false",
                "!mmm                 chat: The cake is a lie",
                "!mmm                 chat: The coffee also",
                "!mmm status",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: broken",
                "!mmm status reset",
                "!mmm chat: correct[1/1]"
            ],
            [
                "!mmm script",
                "!mmm    chat: broken",
                "!mmm    if true",
                "!mmm        end unknown",
                "!mmm    end if",
                "!mmm    chat: broken",
                "!mmm end script",
                "!mmm chat: correct[1/1]",
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/1]",
                "!mmm         exit script",
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: broken",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/3]",
                "!mmm         exit script if 1 == 2",
                "!mmm         chat: correct[2/3]",
                "!mmm     end combine",
                "!mmm     chat: correct[3/3]",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/1]",
                "!mmm         exit script if 1 != 2",
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: broken",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/2]",
                "!mmm         exit combine",
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: correct[2/2]",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     if true",
                "!mmm         chat: correct[1/2]",
                "!mmm         exit if",
                "!mmm         chat: broken",
                "!mmm     end if",
                "!mmm     chat: correct[2/2]",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: broken",
                "!mmm         exit unknown",
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: broken",
                "!mmm end script",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: Hello World!",
                "!mmm     chat: Meaning of life: ${6*7},",
                "!mmm     chat: current AP: ${getattr('Dummy', 'AP')}",
                "!mmm     do chat('and even from expressions')",
                "!mmm end combine",
            ],
            [
                "!mmm combine chat using '//'",
                "!mmm     chat: foo",
                "!mmm     chat: bar",
                "!mmm     chat: baz",
                "!mmm end combine",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: testing maths...",
                "!mmm     if 1 < 2",
                "!mmm        chat: maths still work",
                "!mmm     else",
                "!mmm        chat: maths broken, abandon universe at once",
                "!mmm     end if",
                "!mmm end combine",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: testing maths...",
                "!mmm     if 1 > 2",
                "!mmm        chat: maths broken, abandon universe at once",
                "!mmm     else",
                "!mmm        chat: maths still work",
                "!mmm     end if",
                "!mmm end combine",
            ],
            [
                "!mmm script",
                "!mmm     set roll = [[1d6]]",
                "!mmm     chat: rolled ${roll}",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     chat: attacking with [[1d20]]",
                "!mmm     set roll = $[[0]]",
                "!mmm     chat: rolled ${roll}, say again: ${$[[0]]}, that is to say: $[[0]]",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm    chat: attacking with [[1d3]]",
                "!mmm    set roll = $[[0]]",
                "!mmm    chat: critical: ${iscritical(roll)}",
                "!mmm    chat: fumble: ${isfumble(roll)}",
                "!mmm end script",
            ],
            [
                "!mmm combine chat",
                "!mmm    set roll = [[1d3]]",
                "!mmm    if iscritical(roll)",
                "!mmm        chat: critical",
                "!mmm    else if isfumble(roll)",
                "!mmm        chat: fumbled",
                "!mmm    else",
                "!mmm        chat: unremarkable",
                "!mmm    end if",
                "!mmm    chat: attack with ${roll}",
                "!mmm end combine",
            ],
            [
                "!mmm chat: fumble: ${isfumble($[[0]])}, critical: ${iscritical($[[0]])}, roll: [[1d3]]",
            ],
            [
                "!mmm script",
                "!mmm     chat: Going to attack...",
                "!mmm     set attackRoll = roll('1d20+12')",
                "!mmm     chat: Rolled attack ${attackRoll}",
                "!mmm     if attackRoll >= 20",
                "!mmm         chat: Success! Rolling damage...",
                "!mmm         set damageRoll = roll('1d6')",
                "!mmm         chat: Dealt ${damageRoll} points of damage",
                "!mmm     end if",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     do roll('1d20')",
                "!mmm     do syntax error",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: {{foo=" + "<br/>\n" +
                "!mmm         chat: bar" + "<br/>\n" +
                "!mmm         chat: baz}} quux",
                "!mmm     end combine",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: first paragraph",
                "!mmm         chat:",
                "!mmm         chat: second paragraph",
                "!mmm     end combine",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: broken, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'broken'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm     set asyncOperation = roll('1d20')",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = default",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm status",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm syntax error",
                "!mmm customize",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm     syntax error",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm     syntax error",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm     do syntax error",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: broken",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{meaning*2}, thrice is ${meaning*3}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     translate [foo]: correct foo translation",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     translate [bar]: correct bar translation",
                "!mmm end customize",
                "!mmm script",
                "!mmm     chat [foo]: broken foo",
                "!mmm     chat [bar]: broken bar",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     translate [foo]: Bedeutung is $[once], doppelte Bedeutung ist $[twice], und sonst $[gibtsnich]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{meaning*2}, thrice is ${meaning*3}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set meaning = 123",
                "!mmm     translate [foo]: Bedeutung is $[once], doppelte Bedeutung ist $[twice], aber $[once]{meaning} ist unbedeutend",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{meaning*2}, thrice is ${meaning*3}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     translate [foo]: Bedeutung is $[once], doppelte Bedeutung ist $[twice]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{syntax error meaning*2}, thrice is ${meaning*3}",
                "!mmm end script",
            ],
            [
                "!mmm customize",
                "!mmm     set customizedSetting = 'correct \"customized\" setting'",
                "!mmm     translate [translatedChat]: correct translated chat message with $[correct_placeholder]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable customizedSetting = 'broken'",
                "!mmm     set customizable settingWithSimpleDefault = 'correct \"default\" setting'",
                "!mmm     set customizable settingWithExpressionDefault = 'correct ' & '\"default\"' & ' setting'",
                "!mmm     chat [translatedChat]: broken translated chat with $[correct_placeholder]{'correct labeled expression'}",
                "!mmm     chat [defaultChat]: correct default chat with $[broken_placeholder]{'correct labeled expression'} and ${'correct expression without label'} and $[correct_misplaced_label]",
                "!mmm     chat [defaultChat]: correct redundant default chat with $[broken_placeholder]{'correct labeled expression'} and ${'correct expression without label'} and $[correct_misplaced_label]",
                "!mmm end script",
            ],
            [
                "!mmm customize export to chat",
                "!mmm customize",
                "!mmm     set customizedSetting = 'correct \"customized\" setting'",
                "!mmm     translate [translatedChat]: correct translated chat message with $[placeholder]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable customizedSetting = 'broken'",
                "!mmm     set customizable settingWithoutDefault",
                "!mmm     set customizable settingWithSimpleDefault = 'correct \"default\" setting'",
                "!mmm     set customizable settingWithExpressionDefault = 'correct ' & '\"default\"' & ' setting'",
                "!mmm     chat [translatedChat]: broken translated chat with $[correct_placeholder]{'labeled expression'}",
                "!mmm     chat [defaultChat]: correct default chat with $[correct_placeholder]{'broken labeled expression'} and ${'broken expression without label'} and $[broken_misplaced_label]",
                "!mmm     chat [defaultChat]: broken redundant default chat with $[broken_placeholder]{'broken labeled expression'} and ${'broken expression without label'} and $[broken_misplaced_label]",
                "!mmm end script",
            ],
        ];

        var processes = [];

        var attributes =
        {
            AP: { current: 20, max: 30 },
        };

        MychScriptContext.prototype.chat = function(message)
        {
            sendChat(this.sender || "Mych's Macro Magic", message);
        };

        MychScriptContext.prototype.whisperback = function(message)
        {
            processes.push(
            {
                type: "whisper",
                message: MychExpression.coerceString(message),
            });
        };

        MychScriptContext.prototype.error = function(exception)
        {
            console.log(exception);

            processes.push(
            {
                type: "error",
                message: "<span class='error'>" + escapeHTML(exception) + "</span>",
            });
        };

        MychScriptContext.prototype.getattr = function(characterNameOrId, attributeName)
        {
            return attributes[attributeName].current;
        }

        MychScriptContext.prototype.getattrmax = function(characterNameOrId, attributeName)
        {
            return attributes[attributeName].max;
        }

        MychScriptContext.prototype.setattr = function(characterNameOrId, attributeName, attributeValue)
        {
            if (attributes[attributeName] == undefined)
            {
                attributes[attributeName] = { current: undefined, max: undefined };
            }

            attributes[attributeName].current = attributeValue;
        }

        MychScriptContext.prototype.setattrmax = function(characterNameOrId, attributeName, attributeValue)
        {
            if (attributes[attributeName] == undefined)
            {
                attributes[attributeName] = { current: undefined, max: undefined };
            }

            attributes[attributeName].max = attributeValue;
        }

        function getObj(type, id)
        {
            return undefined;
        }

        function findObjs(props)
        {
            return [];
        }

        function sendChat(sender, message, callback, options)
        {
            var results = [];

            var rollRegExp = /^\/roll\s+(?<expression>.+)/i;
            var rollMatch = rollRegExp.exec(message);

            if (rollMatch)
            {
                var rollExpression = rollMatch.groups.expression;
                var rollResults = executeRoll(rollExpression);

                results.push({ who: sender, type: "rollresult", content: JSON.stringify(rollResults), origRoll: rollExpression });
            }
            else
            {
                results.push({ who: sender, type: "general", content: message });
            }

            if (callback)
            {
                var sendChatProcess = function()
                {
                    callback(results);
                }

                processes.push(
                {
                    type: "process",
                    message: message,
                    execute: sendChatProcess,
                });
            }
            else
            {
                processes.push(
                {
                    type: "chat",
                    message: message,
                });
            }
        }

        function executeRoll(rollExpression)
        {
            var rollExpressionRegExp = /^(?<numDice>\d+)?d(?<numSides>\d+)(?<modifier>[-+]\d+)?$/i;
            var rollExpressionMatch = rollExpressionRegExp.exec(rollExpression);

            if (!rollExpressionMatch)
            {
                return undefined;
            }

            var numDice = parseInt(rollExpressionMatch.groups.numDice || 1);
            var numSides = parseInt(rollExpressionMatch.groups.numSides);
            var modifier = parseInt(rollExpressionMatch.groups.modifier || 0)

            var rollResults = 
            {
                rolls:
                [
                    {
                        type: "R",
                        dice: numDice,
                        sides: numSides,
                        results: [],
                    },
                ],
                total: 0,
            };

            for (; numDice > 0; --numDice)
            {
                var rollValue = Math.floor(Math.random() * numSides) + 1;
                
                rollResults.rolls[0].results.push({ v: rollValue });
                rollResults.total += rollValue;
            }

            if (modifier)
            {
                rollResults.rolls.push({ type: "M", expr: rollExpressionMatch.groups.modifier });
                rollResults.total += modifier;
            }

            return rollResults;
        }

        for (var scriptSourceIndex = 0; scriptSourceIndex < scriptSources.length; ++scriptSourceIndex)
        {
            if (includedScriptSources.length > 0 && !includedScriptSources.includes(scriptSourceIndex))
            {
                continue;
            }

            var scriptSource = scriptSources[scriptSourceIndex];

            document.write("<div class='script'>");
            document.write("<table>");
            document.write("<tr><td></td><td class='script-header'>test script " + scriptSourceIndex + "</td></tr>");

            MychScriptContext.players = {};

            for (var scriptSourceLineIndex = 0; scriptSourceLineIndex < scriptSource.length; ++scriptSourceLineIndex)
            {
                var scriptSourceLine = scriptSource[scriptSourceLineIndex];
                var scriptSourceRolls = [];

                var originalScriptSourceLine = scriptSourceLine;

                scriptSourceLine = scriptSourceLine.replace(/\[\[([^\]]*[^\d\]][^\]]*)\]\]/gi,
                    function(substring, rollExpression)
                    {
                        scriptSourceRolls.push(
                        {
                            expression: rollExpression,
                            results: executeRoll(rollExpression),
                        });

                        return "$[[" + (scriptSourceRolls.length - 1) + "]]";
                    });

                document.write("<tr>");
                
                document.write("<td class='lineno'>");
                document.write(scriptSourceLineIndex + 1);
                document.write("</td>");

                document.write("<td>");
                document.write(escapeHTML(scriptSourceLine));

                if (scriptSourceLine != originalScriptSourceLine)
                {
                    document.write(" <span class='original'>" + escapeHTML(originalScriptSourceLine.trim()) + "</span>")
                }

                document.write("</td>");
                document.write("</tr>");

                var msg =
                {
                    type: "api",
                    playerid: "player1234",
                    who: "Tester",
                    content: scriptSourceLine,
                    inlinerolls: scriptSourceRolls,
                };

                eventHandlers["chat:message"](msg);

                while (processes.length > 0)
                {
                    var process = processes.shift();

                    document.write("<tr>");
                    document.write("<td class='lineno'>" + process.type + "</td>");
                    document.write("<td class='output'>" + process.message.replace(/\b(broken)\b/g, "\u274C<span class='error'>$1</span>") + "</td>");
                    document.write("</tr>");

                    if (process.execute)
                    {
                        process.execute();
                    }
                }
            }

            document.write("</table>");
            document.write("</div>");
        }
    </script>
</body>
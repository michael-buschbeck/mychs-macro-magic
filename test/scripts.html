<!DOCTYPE HTML>
<head>
    <title>
        Script Tests &ndash; Mych's Macro Magic
    </title>
    <script>
        eventHandlers = {};

        function on(eventName, eventHandler)
        {
            eventHandlers[eventName] = eventHandler;
        }
    </script>
    <script src="../MychsMacroMagic.js">
    </script>
    <script>
        function escapeHTML(text)
        {
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
    <style type="text/css">
        body {
            font-family: Consolas, monospace;
            font-size: 9pt;
        }

        div.script {
            padding: 0.5em 1em 1em 1em;
            border: 1px solid silver;
            margin-bottom: 1em;
            white-space: pre-wrap;
        }

        td {
            vertical-align: top;
            line-height: 10pt;
        }

        td.script-header {
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 10pt;
            padding-bottom: 0.5em;
        }

        td.lineno {
            width: 3em;
            color: gray;
            font-family: Calibri, sans-serif;
            text-align: right;
            padding-right: 1em;
        }

        span.original {
            color: gray;
            font-family: Calibri, sans-serif;
            font-style: italic;
        }

        span.state {
            color: gray;
            font-family: Calibri, sans-serif;
        }

        span.error {
            color: red;
            font-family: Calibri, sans-serif;
        }
    </style>
</head>
<body>
    <script>
        var includedScriptSources = [];

        var scriptSources =
        [
            [
                "!mmm do chat(version)",
            ],
            [
                "!mmm",
                "!mmm ",
                "!mmm  ",
                "!mmm   ",
                "!mmm    chat: success",
            ],
            [
                "!mmm chat: sender = ${sender}, playerid = ${playerid}, version = ${version}",
            ],
            [
                "!mmm set correct = 123 + 456",
            ],
            [
                "!mmm set missingExpression",
            ],
            [
                "!mmm set incorrectAssignmentOperator := 123 + 456",
            ],
            [
                "!mmm do chat('correct')"
            ],
            [
                "!mmm do chat 'unknown operator'!"
            ],
            [
                "!mmm do chat 'missing parentheses'"
            ],
            [
                "!mmm     unknown command",
            ],
            [
                "!mmm chat: Hello World! Meaning of life: ${6*7}, current AP: ${getattr('Dummy', 'AP')}",
            ],
            [
                "!mmm chat: this <${undefinedValue}> should be empty",
            ],
            [
                "!mmm chat: floor(.) = (-1.2) = ${floor(-1.2)}, (-1.5) = ${floor(-1.5)}, (-1.7) = ${floor(-1.7)}, (1.2) = ${floor(1.2)}, (1.5) = ${floor(1.5)}, (1.7) = ${floor(1.7)}",
                "!mmm chat: round(.) = (-1.2) = ${round(-1.2)}, (-1.5) = ${round(-1.5)}, (-1.7) = ${round(-1.7)}, (1.2) = ${round(1.2)}, (1.5) = ${round(1.5)}, (1.7) = ${round(1.7)}",
                "!mmm chat: ceil(.) = (-1.2) = ${ceil(-1.2)}, (-1.5) = ${ceil(-1.5)}, (-1.7) = ${ceil(-1.7)}, (1.2) = ${ceil(1.2)}, (1.5) = ${ceil(1.5)}, (1.7) = ${ceil(1.7)}",
                "!mmm chat: abs(.) = (-1.2) = ${abs(-1.2)}, (-1.5) = ${abs(-1.5)}, (-1.7) = ${abs(-1.7)}, (1.2) = ${abs(1.2)}, (1.5) = ${abs(1.5)}, (1.7) = ${abs(1.7)}",
            ],
            [
                "!mmm chat: min() = <${min()}>, min(+123, undef) = ${min(+123, undef)}, min(.) = ${min(5, undefined, 'moo', 999, 2, -3.14)}",
                "!mmm chat: max() = <${max()}>, min(-456, undef) = ${min(-456, undef)}, max(.) = ${max(5, undefined, 'moo', 999, 2, -3.14)}",
            ],
            [
                "!mmm chat: this is ${highlight('rather normal')}, ${highlight('rather good', 'good')}, ${highlight('rather bad', 'bad')}, or ${highlight('very important', 'important')} indeed",
                "!mmm chat: but hover ${highlight('this', 'normal', 'fancy tooltip')} for a tooltip",
            ],
            [
                "!mmm else",
            ],
            [
                "!mmm if true",
                "!mmm else",
                "!mmm else",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm else if broken syntax in expression",
                "!mmm end if",
            ],
            [
                "!mmm if true",
                "!mmm    chat: correct",
                "!mmm else if true",
                "!mmm    chat: broken",
                "!mmm else",
                "!mmm    chat: broken",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm    chat: broken",
                "!mmm else if true",
                "!mmm    chat: correct",
                "!mmm else",
                "!mmm    chat: broken",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm    chat: broken",
                "!mmm else if false",
                "!mmm    chat: broken",
                "!mmm else",
                "!mmm    chat: correct",
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm    if true",
                "!mmm        chat: wrong",
                "!mmm    end if",
                "!mmm else",
                "!mmm    chat: correct",
                "!mmm end if",
            ],
            [
                "!mmm chat: foo",
                "!mmm chat: bar",
            ],
            [
                "!mmm set discardedVariable = 123 + 456",
                "!mmm chat: discardedVariable=${discardedVariable}",
            ],
            [
                "!mmm script",
                "!mmm     set retainedVariable = 123 + 456",
                "!mmm     chat: retainedVariable=${retainedVariable}",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     chat: wrong",
                "!mmm script",
                "!mmm     chat: correct",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm    end script syntax error",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm    chat: wrong",
                "!mmm    if true",
                "!mmm        syntax error",
                "!mmm    end if",
                "!mmm end script",
                "!mmm chat: correct",
            ],
            [
                "!mmm script",
                "!mmm    chat: wrong",
                "!mmm    if true",
                "!mmm end script",
                "!mmm chat: correct",
            ],
            [
                "!mmm script",
                "!mmm    chat: wrong",
                "!mmm    if true",
                "!mmm        end unknown",
                "!mmm    end if",
                "!mmm    chat: wrong",
                "!mmm end script",
                "!mmm chat: correct",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: Hello World!",
                "!mmm     chat: Meaning of life: ${6*7},",
                "!mmm     chat: current AP: ${getattr('Dummy', 'AP')}",
                "!mmm     do chat('and even from expressions')",
                "!mmm end combine",
            ],
            [
                "!mmm combine chat using '//'",
                "!mmm     chat: foo",
                "!mmm     chat: bar",
                "!mmm     chat: baz",
                "!mmm end combine",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: testing maths...",
                "!mmm     if 1 < 2",
                "!mmm        chat: maths still work",
                "!mmm     else",
                "!mmm        chat: maths broken, abandon universe at once",
                "!mmm     end if",
                "!mmm end combine",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: testing maths...",
                "!mmm     if 1 > 2",
                "!mmm        chat: maths broken, abandon universe at once",
                "!mmm     else",
                "!mmm        chat: maths still work",
                "!mmm     end if",
                "!mmm end combine",
            ],
            [
                "!mmm script",
                "!mmm     set roll = [[1d6]]",
                "!mmm     chat: rolled ${roll}",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     chat: attacking with [[1d20]]",
                "!mmm     set roll = $[[0]]",
                "!mmm     chat: rolled ${roll}, say again: ${$[[0]]}, that is to say: $[[0]]",
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm    chat: attacking with [[1d3]]",
                "!mmm    set roll = $[[0]]",
                "!mmm    chat: critical: ${iscritical(roll)}",
                "!mmm    chat: fumble: ${isfumble(roll)}",
                "!mmm end script",
            ],
            [
                "!mmm combine chat",
                "!mmm    set roll = [[1d3]]",
                "!mmm    if iscritical(roll)",
                "!mmm        chat: critical",
                "!mmm    else if isfumble(roll)",
                "!mmm        chat: fumbled",
                "!mmm    else",
                "!mmm        chat: unremarkable",
                "!mmm    end if",
                "!mmm    chat: attack with ${roll}",
                "!mmm end combine",
            ],
            [
                "!mmm chat: fumble: ${isfumble($[[0]])}, critical: ${iscritical($[[0]])}, roll: [[1d3]]",
            ],
        ];

        var processes = [];

        var attributes =
        {
            AP: { current: 20, max: 30 },
        };

        MychScriptContext.prototype.chat = function(message)
        {
            document.write("<tr>");
            document.write("<td class='lineno'>chat</td>");
            document.write("<td>" + message + "</td>");
            document.write("</tr>");
        };

        MychScriptContext.prototype.error = function(exception)
        {
            console.log(exception);

            document.write("<tr>");
            document.write("<td class='lineno'>error</td>");
            document.write("<td><span class='error'>" + escapeHTML(exception) + "</span></td>")
            document.write("</tr>")
        };

        MychScriptContext.prototype.getattr = function(characterNameOrId, attributeName)
        {
            return attributes[attributeName].current;
        }

        MychScriptContext.prototype.getattrmax = function(characterNameOrId, attributeName)
        {
            return attributes[attributeName].max;
        }

        MychScriptContext.prototype.setattr = function(characterNameOrId, attributeName, attributeValue)
        {
            if (attributes[attributeName] == undefined)
            {
                attributes[attributeName] = { current: undefined, max: undefined };
            }

            attributes[attributeName].current = attributeValue;
        }

        MychScriptContext.prototype.setattrmax = function(characterNameOrId, attributeName, attributeValue)
        {
            if (attributes[attributeName] == undefined)
            {
                attributes[attributeName] = { current: undefined, max: undefined };
            }

            attributes[attributeName].max = attributeValue;
        }

        MychScriptContext.prototype.$rollWithCallback = function(rollExpression, rollCallback)
        {
            var context = this;

            var sendChatCallback = function(msgs)
            {
                var rollResultsMsg = msgs.filter(msg => msg.type == "rollresult")[0];
                
                if (!rollResultsMsg)
                {
                    console.log("No roll result found in sendChat() results:", msgs);
                    return;
                }

                var rollResults = JSON.parse(rollResultsMsg.content);
                rollCallback(context.$decorateRoll({ results: rollResults, expression: rollResultsMsg.origRoll }));
            };

            sendChatRollWithCallback(rollExpression, sendChatCallback);
        }

        function sendChatRollWithCallback(rollExpression, callback)
        {
            var sendChatProcess = function()
            {
                var rollResults = executeRoll(rollExpression);

                document.write("<tr>");
                document.write("<td class='lineno'>roll</td>");
                document.write("<td>" + rollExpression + " \u2192 " + rollResults.total + "</td>");
                document.write("</tr>");

                callback([{ type: "rollresult", content: JSON.stringify(rollResults), origRoll: rollExpression }]);
            };

            processes.push({ label: "/roll " + rollExpression, execute: sendChatProcess });
        }

        function executeRoll(rollExpression)
        {
            var rollExpressionRegExp = /^(?<numDice>\d+)?d(?<numSides>\d+)(?<modifier>[-+]\d+)?$/i;
            var rollExpressionMatch = rollExpressionRegExp.exec(rollExpression);

            if (!rollExpressionMatch)
            {
                return undefined;
            }

            var numDice = parseInt(rollExpressionMatch.groups.numDice || 1);
            var numSides = parseInt(rollExpressionMatch.groups.numSides);
            var modifier = parseInt(rollExpressionMatch.groups.modifier || 0)

            var rollResults = 
            {
                rolls:
                [
                    {
                        type: "R",
                        dice: numDice,
                        sides: numSides,
                        results: [],
                    },
                ],
                total: 0,
            };

            for (; numDice > 0; --numDice)
            {
                var rollValue = Math.floor(Math.random() * numSides) + 1;
                
                rollResults.rolls[0].results.push({ v: rollValue });
                rollResults.total += rollValue;
            }

            if (modifier)
            {
                rollResults.rolls.push({ type: "M", expr: rollExpressionMatch.groups.modifier });
                rollResults.total += modifier;
            }

            return rollResults;
        }

        for (var scriptSourceIndex = 0; scriptSourceIndex < scriptSources.length; ++scriptSourceIndex)
        {
            if (includedScriptSources.length > 0 && !includedScriptSources.includes(scriptSourceIndex))
            {
                continue;
            }

            var scriptSource = scriptSources[scriptSourceIndex];

            document.write("<div class='script'>");
            document.write("<table>");
            document.write("<tr><td></td><td class='script-header'>test script " + scriptSourceIndex + "</td></tr>");

            MychScriptContext.players = {};

            for (var scriptSourceLineIndex = 0; scriptSourceLineIndex < scriptSource.length; ++scriptSourceLineIndex)
            {
                var scriptSourceLine = scriptSource[scriptSourceLineIndex];
                var scriptSourceRolls = [];

                var originalScriptSourceLine = scriptSourceLine;

                scriptSourceLine = scriptSourceLine.replace(/\[\[([^\]]*[^\d\]][^\]]*)\]\]/gi,
                    function(substring, rollExpression)
                    {
                        scriptSourceRolls.push(
                        {
                            expression: rollExpression,
                            results: executeRoll(rollExpression),
                        });

                        return "$[[" + (scriptSourceRolls.length - 1) + "]]";
                    });

                document.write("<tr>");
                
                document.write("<td class='lineno'>");
                document.write(scriptSourceLineIndex + 1);
                document.write("</td>");

                document.write("<td>");
                document.write(escapeHTML(scriptSourceLine));

                if (scriptSourceLine != originalScriptSourceLine)
                {
                    document.write(" <span class='original'>" + escapeHTML(originalScriptSourceLine.trim()) + "</span>")
                }

                document.write("</td>");
                document.write("</tr>");

                var msg =
                {
                    type: "api",
                    playerid: "player1234",
                    who: "Tester",
                    content: scriptSourceLine,
                    inlinerolls: scriptSourceRolls,
                };

                eventHandlers["chat:message"](msg);
            }

            while (processes.length > 0)
            {
                var process = processes.shift();

                document.write("<tr>");
                document.write("<td class='lineno'>process</td>");
                document.write("<td>" + escapeHTML(process.label) + "</td>");
                document.write("</tr>");

                process.execute();
            }

            document.write("</table>");
            document.write("</div>");
        }
    </script>
</body>
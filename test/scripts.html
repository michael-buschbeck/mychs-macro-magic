<!DOCTYPE HTML>
<head>
    <title>
        Script Tests &ndash; Mych's Macro Magic
    </title>
    <script>
        eventHandlers = {};

        function on(eventName, eventHandler)
        {
            eventHandlers[eventName] = eventHandler;
        }
    </script>
    <script src="../MychsMacroMagic.js">
    </script>
    <script>
        function escapeHTML(text)
        {
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function normalizeHTML(html)
        {
            html = String(html);

            html = html.replace(/&#(\d+);/g, function(match, decimal)
            {
                let character = String.fromCodePoint(parseInt(decimal));
                return (["&", "<", ">"].includes(character) ? match : character);
            });

            html = html.replace(/&#(38|x26);/ig, "&amp;");
            html = html.replace(/&#(60|x3C);/ig, "&lt;");
            html = html.replace(/&#(62|x3E);/ig, "&gt;");

            return html;
        }
    </script>
    <style type="text/css">
        body {
            font-family: Consolas, monospace;
            font-size: 9pt;
            line-height: 13pt;
        }

        div.script {
            padding: 0.5em 1em 1em 1em;
            border: 1px solid silver;
            margin-bottom: 1em;
            white-space: pre-wrap;
        }

        div.results-success {
            padding: 0.5em 1em;
            border: 1px solid gray;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 12pt;
            color: green;
            background: #C0FFC0;
        }

        div.results-failure {
            padding: 0.5em 1em;
            border: 1px solid gray;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 12pt;
            color: red;
            background: #FFC0C0;
        }

        td {
            vertical-align: top;
            padding: 0;
            margin: 0;
        }

        td.script-header {
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 10pt;
            padding-bottom: 0.5em;
        }

        td.lineno {
            width: 3em;
            color: gray;
            font-family: Calibri, sans-serif;
            text-align: right;
            padding-right: 1em;
        }

        td.output {
            font-family: Calibri, sans-serif;
            white-space: pre-wrap;
        }

        tr.ok td.output {
            color: green;
        }

        tr.unexpected td {
            color: red;
        }

        tr.expected td {
            background: yellow;
        }

        div.sheet-rolltemplate-default table {
            border: 1px solid;
            color: black;
            border-color: rgba(112, 32, 130,1);
            font-size: 1em;
            font-family: "Helvetica Neue", Helvetica, sans-serif;
        }

        div.sheet-rolltemplate-default caption {
            background-color: rgba(112, 32, 130,1);
            color: #ffffff;
            padding: 2px;
            border-bottom: 1px solid black;
            line-height: 1.6em;
            font-size: 1.2em;
        }

        div.sheet-rolltemplate-default td {
            padding: 5px;
        }

        div.sheet-rolltemplate-default td:nth-child(1) {
            font-weight: bold;
        }

        div.sheet-rolltemplate-default tr:nth-child(odd) {
            background-color: rgba(217, 217, 214,1);
        }

        div.sheet-rolltemplate-default tr:nth-child(even) {
            background-color: rgba(233, 233, 233,1);
        }

        span.original {
            color: gray;
            font-family: Calibri, sans-serif;
            font-style: italic;
        }

        span.state {
            color: gray;
            font-family: Calibri, sans-serif;
        }
    </style>
</head>
<body>
    <script>
        let includedScriptSources = [];

        let scriptSources =
        [
            [
                "!mmm do chat(version)",
                { chat: /^\d+\.\d+\.\d+$/ },
            ],
            [
                "!mmm",
                "!mmm ",
                "!mmm  ",
                "!mmm   ",
                "!mmm    chat: success",
                { chat: "success" }
            ],
            [
                "!mmm chat: sender = ${sender}, playerid = ${playerid}, version = ${version}",
                { chat: /^sender = Tester, playerid = player1234, version = \d+\.\d+\.\d+$/ },
            ],
            [
                "!mmm set correct = 123 + 456",
                { whisper: "‚ö†Ô∏è Value of <strong>correct</strong> won't survive being <strong>set</strong> outside of a <strong>script</strong> block" },
            ],
            [
                "!mmm set missingExpression",
                { error: "During parse, syntax error in script: !mmm set missingExpression‚ùå"}
            ],
            [
                "!mmm set incorrectAssignmentOperator := 123 + 456",
                { error: "During parse, syntax error in script: !mmm set incorrectAssignmentOperator ‚ùå:= 123 + 456" },
            ],
            [
                "!mmm set 123 = 456",
                { error: "During parse, syntax error in script: !mmm set ‚ùå123 = 456" },
            ],
            [
                "!mmm script",
                "!mmm     set √§√∂√º = 456",
                "!mmm     chat: ${√§√∂√º + 123}",
                "!mmm end script",
                { chat: "579" },
            ],
            [
                "!mmm set customizable 123",
                { error: "During parse, syntax error in script: !mmm set customizable ‚ùå123" },
            ],
            [
                "!mmm set customizable √§√∂√º",
                { whisper: "‚ö†Ô∏è Value of <strong>√§√∂√º</strong> won't survive being <strong>set</strong> outside of a <strong>script</strong> block" },
                { error: "During execute, require customization or default in script: !mmm set customizable √§√∂√º‚ùå" },
            ],
            [
                "!mmm set customizable 123 = 456",
                { error: "During parse, syntax error in script: !mmm set customizable ‚ùå123 = 456" },
            ],
            [
                "!mmm set customizable √§√∂√º = 456",
                { whisper: "‚ö†Ô∏è Value of <strong>√§√∂√º</strong> won't survive being <strong>set</strong> outside of a <strong>script</strong> block" },
            ],
            [
                "!mmm for 123 in 1, 2, 3",
                { error: "During parse, syntax error in script: !mmm for ‚ùå123 in 1, 2, 3" },
                "!mmm end for",
                { error: "During parse, unknown command in script: !mmm ‚ùåend for" },
            ],
            [
                "!mmm for √§√∂√º in 1, 2, 3",
                "!mmm     chat: ${√§√∂√º}",
                "!mmm end for",
                { chat: "1" },
                { chat: "2" },
                { chat: "3" },
            ],
            [
                "!mmm chat: ${syntax error}",
                { error: "During parse, expected binary operator, or property lookup, or opening parenthesis (for function arguments), or opening bracket (for array subscript), or end of expression in expression in template in script: !mmm chat: ${syntax ‚ùåerror}" },
            ],
            [
                "!mmm do chat('correct')",
                { chat: "correct" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         do chat('correct[1/2]')",
                "!mmm     end combine",
                "!mmm     do chat('correct[2/2]')",
                "!mmm end script",
                { chat: "correct[1/2]" },
                { chat: "correct[2/2]" },
            ],
            [
                "!mmm script",
                "!mmm     set chat = whisperback",
                "!mmm     do chat('whisper')",
                "!mmm end script",
                { whisper: "whisper" },
            ],
            [
                "!mmm script",
                "!mmm     set chat = undef",
                "!mmm     do chat('broken')",
                "!mmm end script",
                { error: "During execute, unknown function in expression in script: !mmm     do chat‚ùå('broken')" },
            ],
            [
                "!mmm script",
                "!mmm     set chat = undef",
                "!mmm     chat: correct",
                "!mmm end script",
                { chat: "correct" },
            ],
            [
                "!mmm do chat 'unknown operator'!",
                { error: "During parse, syntax error in expression in script: !mmm do chat 'unknown operator'‚ùå!" },
            ],
            [
                "!mmm do chat 'missing parentheses'",
                { error: "During parse, expected binary operator, or property lookup, or opening parenthesis (for function arguments), or opening bracket (for array subscript), or end of expression in expression in script: !mmm do chat ‚ùå'missing parentheses'" }
            ],
            [
                "!mmm     unknown command",
                { error: "During parse, unknown command in script: !mmm     ‚ùåunknown command" },
            ],
            [
                "!mmm chat: Hello World! Meaning of life: ${6*7}, current HP: ${getattr('Finn', 'HP')}",
                { chat: "Hello World! Meaning of life: 42, current HP: 20" },
            ],
            [
                "!mmm chat: Finn's name: ${'Finn'.name}, HP: ${'Finn'.HP}, max: ${'Finn'.HP.max}",
                { chat: "Finn's name: Finn MacRathgar, HP: 20, max: 30" },
            ],
            [
                "!mmm chat: Finn's brother's name: ${'Finn'.brother.name}, HP: ${'Finn'.brother.HP}, max: ${'Finn'.brother.HP.max}",
                { chat: "Finn's brother's name: <span class=\"mmm-unknown showtip tipsy-n-right\" title=\"Unknown attribute: brother\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold; cursor: help\">unknown</span>, HP: <span class=\"mmm-unknown showtip tipsy-n-right\" title=\"Unknown attribute: brother\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold; cursor: help\">unknown</span>, max: <span class=\"mmm-unknown showtip tipsy-n-right\" title=\"Unknown attribute: brother\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold; cursor: help\">unknown</span>" },
            ],
            [
                "!mmm chat: Finn's cousin's name: ${'Finn'.cousin.name}, HP: ${'Finn'.cousin.HP}, max: ${'Finn'.cousin.HP.max}",
                { chat: "Finn's cousin's name: Yorrick MacRathgar, HP: 18, max: 28" },
            ],
            [
                "!mmm chat: this <${undefinedValue}> should be empty",
                { chat: "this <> should be empty" },
            ],
            [
                "!mmm chat: this is \\${escaped} but ${'this is not'}",
                { chat: "this is \${escaped} but this is not" },
            ],
            [
                "!mmm chat: this is \\\\${'not escaped'}",
                { chat: "this is \\not escaped" },
            ],
            [
                "!mmm chat: this is \\$[escaped]{escaped} but ${'this is not'}",
                { chat: "this is \$[escaped]{escaped} but this is not" },
            ],
            [
                "!mmm if undefinedVariable",
                "!mmm     chat: broken",
                "!mmm else",
                "!mmm     chat: correct",
                "!mmm end if",
                { chat: "correct" },
            ],
            [
                "!mmm if not undefinedVariable",
                "!mmm     chat: correct",
                "!mmm else",
                "!mmm     chat: broken",
                "!mmm end if",
                { chat: "correct" },
            ],
            [
                "!mmm if not (undefinedVariable1) or not (undefinedVariable2)",
                "!mmm     chat: correct",
                "!mmm else",
                "!mmm     chat: broken",
                "!mmm end if",
                { chat: "correct" },
            ],
            [
                "!mmm if (not undefinedVariable1) or (not undefinedVariable2)",
                "!mmm     chat: correct",
                "!mmm else",
                "!mmm     chat: broken",
                "!mmm end if",
                { chat: "correct" },
            ],
            [
                "!mmm script",
                "!mmm     set weapons = 'slingshot', 'sword'",
                "!mmm     set label = 'sword'",
                "!mmm     if weapons where ... eq label",
                "!mmm         chat: correct",
                "!mmm     end if",
                "!mmm end script",
                { chat: "correct" },
            ],
            [
                "!mmm chat: isdefault(default) = ${isdefault(default)}",
                { chat: "isdefault(default) = true" },
                "!mmm chat: isdenied(denied) = ${isdenied(denied)}",
                { chat: "isdenied(denied) = true" },
                "!mmm chat: isunknown(unknown) = ${isunknown(unknown)}",
                { chat: "isunknown(unknown) = true" },
                "!mmm chat: isdenied(unknown) = ${isdenied(unknown)}",
                { chat: "isdenied(unknown) = false" },
                "!mmm chat: isunknown(denied) = ${isunknown(denied)}",
                { chat: "isunknown(denied) = false" },
                "!mmm chat: getreason(default) = ${getreason(default)}",
                { chat: "getreason(default) = <span class=\"mmm-unknown showtip tipsy-n-right\" title=\"Only <strong>denied</strong> and <strong>unknown</strong> values can have a reason\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold; cursor: help\">unknown</span>" },
                "!mmm chat: getreason(denied) = ${getreason(denied)}",
                { chat: "getreason(denied) = " },
                "!mmm chat: getreason(unknown) = ${getreason(unknown)}",
                { chat: "getreason(unknown) = " },
            ],
            [
                "!mmm chat: ${? default + 123}",
                { whisper: "üîé <span style=\"background: gray; border: 2px solid gray; color: white; font-weight: bold\">default</span> ‚óÄÔ∏è ? <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>default</span> + 123" },
                { chat: "123" },
                "!mmm chat: ${? denied + 123}",
                { whisper: "üîé <span class=\"mmm-denied\" style=\"background: red; border: 2px solid red; color: white; font-weight: bold\">denied</span> ‚óÄÔ∏è ? <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>denied</span> + 123" },
                { chat: "123" },
                "!mmm chat: ${? unknown + 123}",
                { whisper: "üîé <span class=\"mmm-unknown\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold\">unknown</span> ‚óÄÔ∏è ? <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>unknown</span> + 123" },
                { chat: "123" },
            ],
            [
                "!mmm debug do 1 + 2",
                { whisper: "üîé <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>3</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>1 + 2</span>" },
                "!mmm script",
                "!mmm     set foo = 42",
                "!mmm     debug do foo",
                "!mmm end script",
                { whisper: "üîé <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>42</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>foo</span>" },
                "!mmm debug do default",
                { whisper: "üîé <span style=\"background: gray; border: 2px solid gray; color: white; font-weight: bold\">default</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>default</span>" },
                "!mmm debug do denied",
                { whisper: "üîé <span class=\"mmm-denied\" style=\"background: red; border: 2px solid red; color: white; font-weight: bold\">denied</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>denied</span>" },
                "!mmm debug do unknown",
                { whisper: "üîé <span class=\"mmm-unknown\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold\">unknown</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>unknown</span>" },
                "!mmm debug do getattr('Finn', 'HP')",
                { whisper: "üîé <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>\"20\"</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>getattr('Finn', 'HP')</span>" },
                "!mmm debug do setattr('Finn', 'HP', getattr('Finn', 'HP') - 1)",
                { whisper: "üîé <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>\"19\"</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>setattr('Finn', 'HP', getattr('Finn', 'HP') - 1)</span>" },
            ],
            [
                "!mmm debug chat: number is ${3.141}",
                { whisper: "üîé number is <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>3.141</span>" },
                "!mmm debug chat: string is ${'foo' & 'bar'}",
                { whisper: "üîé string is <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>\"foobar\"</span>" },
                "!mmm debug chat: bool is ${1 == 2}",
                { whisper: "üîé bool is <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>false</span>" },
                "!mmm debug chat: undefined is ${undefined}",
                { whisper: "üîé undefined is <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>undef</span>" },
                "!mmm debug chat: list is ${1, 2, 3, 'foo', 'bar', 'baz', undefined}",
                { whisper: "üîé list is <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>1, 2, 3, \"foo\", \"bar\", \"baz\"</span>" },
                "!mmm debug chat: default is ${default}",
                { whisper: "üîé default is <span style=\"background: gray; border: 2px solid gray; color: white; font-weight: bold\">default</span>" },
                "!mmm debug chat: denied is ${denied}",
                { whisper: "üîé denied is <span class=\"mmm-denied\" style=\"background: red; border: 2px solid red; color: white; font-weight: bold\">denied</span>" },
                "!mmm debug chat: unknown is ${unknown}",
                { whisper: "üîé unknown is <span class=\"mmm-unknown\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold\">unknown</span>" },
                "!mmm debug chat: roll is ${roll('1d6')}",
                { process: "/roll 1d6" },
                { whisper: /^üîé roll is <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d6" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">[1-6]<\/span>/ },
            ],
            [
                "!mmm chat: this is ${highlight('rather normal')}, ${highlight('rather good', 'good')}, ${highlight('rather bad', 'bad')}, ${highlight('very important', 'important')}, or ${highlight('just information', 'info')} indeed",
                { chat: "this is <span class=\"mmm-highlight mmm-highlight-normal\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #FEF68E;font-weight:bold;font-size:1.1em\">rather normal</span>, <span class=\"mmm-highlight mmm-highlight-good\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #3FB315;font-weight:bold;font-size:1.1em\">rather good</span>, <span class=\"mmm-highlight mmm-highlight-bad\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #B31515;font-weight:bold;font-size:1.1em\">rather bad</span>, <span class=\"mmm-highlight mmm-highlight-important\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #4A57ED;font-weight:bold;font-size:1.1em\">very important</span>, or <span class=\"mmm-highlight mmm-highlight-info\" style=\"padding:0 3px 0 3px;color:black;background-color:#E0E0E0;border:2px solid #E0E0E0;font-weight:bold;font-size:1.1em\">just information</span> indeed" },
                "!mmm chat: but hover ${highlight('this', 'normal', 'fancy tooltip')} for a tooltip",
                { chat: "but hover <span class=\"mmm-highlight mmm-highlight-normal showtip tipsy-n-right\" title=\"fancy tooltip\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #FEF68E;font-weight:bold;font-size:1.1em;cursor:help\">this</span> for a tooltip" },
            ],
            [
                "!mmm else",
                { error: "During parse, unexpected \"else\" outside of \"if\" block in script: !mmm ‚ùåelse" },
            ],
            [
                "!mmm if true",
                "!mmm else",
                "!mmm else",
                { error: "During parse, unexpected \"else\" after previous \"else\" in same \"if\" block in script: !mmm ‚ùåelse" },
                "!mmm end if",
            ],
            [
                "!mmm if false",
                "!mmm else if broken syntax in expression",
                { error: "During parse, expected binary operator, or property lookup, or opening parenthesis (for function arguments), or opening bracket (for array subscript), or end of expression in expression in script: !mmm else if broken ‚ùåsyntax in expression" },
                "!mmm end if",
            ],
            [
                "!mmm if true",
                "!mmm    chat: correct[1/1]",
                "!mmm else if true",
                "!mmm    chat: broken",
                "!mmm else",
                "!mmm    chat: broken",
                "!mmm end if",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm if false",
                "!mmm    chat: broken",
                "!mmm else if true",
                "!mmm    chat: correct[1/1]",
                "!mmm else",
                "!mmm    chat: broken",
                "!mmm end if",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm if false",
                "!mmm    chat: broken",
                "!mmm else if false",
                "!mmm    chat: broken",
                "!mmm else",
                "!mmm    chat: correct[1/1]",
                "!mmm end if",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm if false",
                "!mmm    if true",
                "!mmm        chat: broken",
                "!mmm    end if",
                "!mmm else",
                "!mmm    chat: correct[1/1]",
                "!mmm end if",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm script",
                "!mmm     set list = list, 1",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm end script",
                { chat: "listnum(list) = 1" },
                { chat: "listidx(list,0) = 1" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, list",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm end script",
                { chat: "listnum(list) = 1" },
                { chat: "listidx(list,0) = 1" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, 2, list",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm     chat: listidx(list,1) = ${listidx(list,1)}",
                "!mmm end script",
                { chat: "listnum(list) = 2" },
                { chat: "listidx(list,0) = 1" },
                { chat: "listidx(list,1) = 2" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, 2",
                "!mmm     set list = list, 3",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm     chat: listidx(list,1) = ${listidx(list,1)}",
                "!mmm     chat: listidx(list,2) = ${listidx(list,2)}",
                "!mmm end script",
                { chat: "listnum(list) = 3" },
                { chat: "listidx(list,0) = 1" },
                { chat: "listidx(list,1) = 2" },
                { chat: "listidx(list,2) = 3" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, 2",
                "!mmm     set list = 3, list",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm     chat: listidx(list,1) = ${listidx(list,1)}",
                "!mmm     chat: listidx(list,2) = ${listidx(list,2)}",
                "!mmm end script",
                { chat: "listnum(list) = 3" },
                { chat: "listidx(list,0) = 3" },
                { chat: "listidx(list,1) = 1" },
                { chat: "listidx(list,2) = 2" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, 2",
                "!mmm     set list = list, undef",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm     chat: listidx(list,1) = ${listidx(list,1)}",
                "!mmm end script",
                { chat: "listnum(list) = 2" },
                { chat: "listidx(list,0) = 1" },
                { chat: "listidx(list,1) = 2" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, 2",
                "!mmm     set list = list, denied",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm     chat: listidx(list,1) = ${listidx(list,1)}",
                "!mmm     chat: isdenied(listidx(list,2)) = ${isdenied(listidx(list,2))}",
                "!mmm end script",
                { chat: "listnum(list) = 3" },
                { chat: "listidx(list,0) = 1" },
                { chat: "listidx(list,1) = 2" },
                { chat: "isdenied(listidx(list,2)) = true" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, 2",
                "!mmm     set list = list, unknown",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm     chat: listidx(list,1) = ${listidx(list,1)}",
                "!mmm     chat: isunknown(listidx(list,2)) = ${isunknown(listidx(list,2))}",
                "!mmm end script",
                { chat: "listnum(list) = 3" },
                { chat: "listidx(list,0) = 1" },
                { chat: "listidx(list,1) = 2" },
                { chat: "isunknown(listidx(list,2)) = true" },
            ],
            [
                "!mmm script",
                "!mmm     set list = 1, 2",
                "!mmm     set list = list, default",
                "!mmm     chat: listnum(list) = ${listnum(list)}",
                "!mmm     chat: listidx(list,0) = ${listidx(list,0)}",
                "!mmm     chat: listidx(list,1) = ${listidx(list,1)}",
                "!mmm     chat: isdefault(listidx(list,2)) = ${isdefault(listidx(list,2))}",
                "!mmm end script",
                { chat: "listnum(list) = 3" },
                { chat: "listidx(list,0) = 1" },
                { chat: "listidx(list,1) = 2" },
                { chat: "isdefault(listidx(list,2)) = true" },
            ],
            [
                "!mmm script",
                "!mmm     for color in 'red', 'green', 'blue'",
                "!mmm         chat: Do you feel ${color} today?",
                "!mmm     end for",
                "!mmm     chat: Residual color: ${color}",
                "!mmm end script",
                { chat: "Do you feel red today?" },
                { chat: "Do you feel green today?" },
                { chat: "Do you feel blue today?" },
                { chat: "Residual color: " },
            ],
            [
                "!mmm script",
                "!mmm     for color in 'blue'",
                "!mmm         chat: Do you feel ${color} today?",
                "!mmm     end for",
                "!mmm     chat: Residual color: ${color}",
                "!mmm end script",
                { chat: "Do you feel blue today?" },
                { chat: "Residual color: " },
            ],
            [
                "!mmm script",
                "!mmm     for number in 123, 999, 17, 5, 100",
                "!mmm         exit for if number < 100",
                "!mmm     end for",
                "!mmm     chat: Number: ${number}",
                "!mmm end script",
                { chat: "Number: 17" },
            ],
            [
                "!mmm script",
                "!mmm     set vertDirections = 'top', 'bottom'",
                "!mmm     set horzDirections = 'left', 'right'",
                "!mmm     for vert in vertDirections",
                "!mmm         for horz in horzDirections",
                "!mmm             chat: ${vert} ${horz}",
                "!mmm         end for",
                "!mmm     end for",
                "!mmm end script",
                { chat: "top left" },
                { chat: "top right" },
                { chat: "bottom left" },
                { chat: "bottom right" },
            ],
            [
                "!mmm chat: foo",
                { chat: "foo" },
                "!mmm chat: bar",
                { chat: "bar" },
            ],
            [
                "!mmm set discardedVariable = 123 + 456",
                { whisper: "‚ö†Ô∏è Value of <strong>discardedVariable</strong> won't survive being <strong>set</strong> outside of a <strong>script</strong> block" },
                "!mmm chat: discardedVariable=${discardedVariable}",
                { chat: "discardedVariable=" },
            ],
            [
                "!mmm script",
                "!mmm     set retainedVariable = 123 + 456",
                "!mmm     chat: retainedVariable=${retainedVariable}",
                "!mmm end script",
                { chat: "retainedVariable=579" },
            ],
            [
                "!mmm script",
                "!mmm     chat: broken",
                "!mmm script",
                "!mmm     chat: correct[1/1]",
                "!mmm end script",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm script",
                "!mmm    end script syntax error",
                { error: "During parse, syntax error in script: !mmm    end script ‚ùåsyntax error" },
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm    chat: broken",
                "!mmm    if true",
                "!mmm        syntax error",
                { error: "During parse, unknown command in script: !mmm        ‚ùåsyntax error" },
                "!mmm    end if",
                "!mmm end script",
                "!mmm chat: correct[1/1]",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm script",
                "!mmm    chat: broken",
                "!mmm    if true",
                "!mmm end script",
                { error: "During parse, unexpected block end in script: !mmm end ‚ùåscript" },
                "!mmm chat: correct[1/1]",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm parse error",
                { error: "During parse, unknown command in script: !mmm ‚ùåparse error" },
                "!mmm script",
                "!mmm    chat: correct[1/2]",
                "!mmm end script",
                { chat: "correct[1/2]" },
                "!mmm chat: correct[2/2]",
                { chat: "correct[2/2]" },
            ],
            [
                "!mmm parse error",
                { error: "During parse, unknown command in script: !mmm ‚ùåparse error" },
                "!mmm combine chat",
                "!mmm    chat: correct[1/2]",
                "!mmm end combine",
                { chat: "correct[1/2]" },
                "!mmm chat: correct[2/2]",
                { chat: "correct[2/2]" },
            ],
            [
                "!mmm status",
                { whisper: /player1234.*Seen.*Context.*Script.*Error/ },
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: broken",
                "!mmm status",
                { whisper: /player1234.*Seen.*Context.*Script.*combine \[chat, \.\.\.\].*Error/ },
            ],
            [
                "!mmm script",
                "!mmm     set foo = 1",
                "!mmm     if true",
                "!mmm         chat: True dat!",
                "!mmm     else",
                "!mmm         combine chat",
                "!mmm             if false",
                "!mmm                 chat: The cake is a lie",
                "!mmm                 chat: The coffee also",
                "!mmm status",
                { whisper: /player1234.*Seen.*Context.*Script.*script \[set, if \[chat, else, combine \[if \[chat, chat, \.\.\.\], \.\.\.\], \.\.\.\], \.\.\.\].*Error/ },
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: broken",
                "!mmm status reset",
                { whisper: "All state reset." },
                "!mmm chat: correct[1/1]",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm script",
                "!mmm    chat: broken",
                "!mmm    if true",
                "!mmm        end unknown",
                { error: "During parse, unexpected block end in script: !mmm        end ‚ùåunknown" },
                "!mmm    end if",
                "!mmm    chat: broken",
                "!mmm end script",
                "!mmm chat: correct[1/1]",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/1]",
                "!mmm         exit script",
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: broken",
                "!mmm end script",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/3]",
                "!mmm         exit script if 1 == 2",
                "!mmm         chat: correct[2/3]",
                "!mmm     end combine",
                "!mmm     chat: correct[3/3]",
                "!mmm end script",
                { chat: "correct[1/3] correct[2/3]" },
                { chat: "correct[3/3]" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/1]",
                "!mmm         exit script if 1 != 2",
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: broken",
                "!mmm end script",
                { chat: "correct[1/1]" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: correct[1/2]",
                "!mmm         exit combine",
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: correct[2/2]",
                "!mmm end script",
                { chat: "correct[1/2]" },
                { chat: "correct[2/2]" },
            ],
            [
                "!mmm script",
                "!mmm     if true",
                "!mmm         chat: correct[1/2]",
                "!mmm         exit if",
                "!mmm         chat: broken",
                "!mmm     end if",
                "!mmm     chat: correct[2/2]",
                "!mmm end script",
                { chat: "correct[1/2]" },
                { chat: "correct[2/2]" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: broken",
                "!mmm         exit unknown",
                { error: "During parse, unexpected block exit in script: !mmm         exit ‚ùåunknown" },
                "!mmm         chat: broken",
                "!mmm     end combine",
                "!mmm     chat: broken",
                "!mmm end script",
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: Hello World!",
                "!mmm     chat: Meaning of life: ${6*7},",
                "!mmm     chat: current HP: ${getattr('Finn', 'HP')}",
                "!mmm     do chat('and even from expressions')",
                "!mmm end combine",
                { chat: "Hello World! Meaning of life: 42, current HP: 19 and even from expressions" },
            ],
            [
                "!mmm combine chat using '//'",
                "!mmm     chat: foo",
                "!mmm     chat: bar",
                "!mmm     chat: baz",
                "!mmm end combine",
                { chat: "foo//bar//baz" },
            ],
            [
                "!mmm combine chat using highlight('//')",
                "!mmm     chat: foo",
                "!mmm     chat: bar",
                "!mmm end combine",
                { chat: "foo<span class=\"mmm-highlight mmm-highlight-normal\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #FEF68E;font-weight:bold;font-size:1.1em\">//</span>bar" },
            ],
            [
                "!mmm combine chat using highlight('//')",
                "!mmm     chat: !foo",
                "!mmm     chat: bar",
                "!mmm end combine",
                { process: "/direct MMM starts impersonation of player1234" },
                { chat: "!foo//bar" },
                { process: "/direct MMM stops impersonation of player1234" },
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: testing maths...",
                "!mmm     if 1 < 2",
                "!mmm        chat: maths still work",
                "!mmm     else",
                "!mmm        chat: maths broken, abandon universe at once",
                "!mmm     end if",
                "!mmm end combine",
                { chat: "testing maths... maths still work" },
            ],
            [
                "!mmm combine chat",
                "!mmm     chat: testing maths...",
                "!mmm     if 1 > 2",
                "!mmm        chat: maths broken, abandon universe at once",
                "!mmm     else",
                "!mmm        chat: maths still work",
                "!mmm     end if",
                "!mmm end combine",
                { chat: "testing maths... maths still work" },
            ],
            [
                "!mmm chat: denied=${denied} default=${default} unknown=${unknown} highlight=${highlight('text', 'normal', 'tooltip')} roll=[[1d1]]",
                { chat: "denied=<span class=\"mmm-denied\" style=\"background: red; border: 2px solid red; color: white; font-weight: bold\">denied</span> default=<span style=\"background: gray; border: 2px solid gray; color: white; font-weight: bold\">default</span> unknown=<span class=\"mmm-unknown\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold\">unknown</span> highlight=<span class=\"mmm-highlight mmm-highlight-normal showtip tipsy-n-right\" title=\"tooltip\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #FEF68E;font-weight:bold;font-size:1.1em;cursor:help\">text</span> roll=<span class=\"mmm-highlight mmm-highlight-important showtip tipsy-n-right\" title=\"Rolling 1d1\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #4A57ED;font-weight:bold;font-size:1.1em;cursor:help\">1</span>" },
                "!mmm chat: !api denied=${denied} default=${default} unknown=${unknown} highlight=${highlight('text', 'normal', 'tooltip')} roll=[[1d1]]",
                { process: "/direct MMM starts impersonation of player1234"},
                { chat: "!api denied= default= unknown= highlight=text roll=1"},
                { process: "/direct MMM stops impersonation of player1234" },
            ],
            [
                "!mmm script",
                "!mmm     set roll = [[1d6]]",
                "!mmm     chat: rolled ${roll}",
                "!mmm end script",
                { chat: /^rolled <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d6" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">[1-6]<\/span>$/ },
            ],
            [
                "!mmm script",
                "!mmm     chat: attacking with [[1d20]]",
                "!mmm     set roll = $[[0]]",
                "!mmm     chat: rolled ${roll}, say again: ${$[[0]]}, that is to say: $[[0]]",
                "!mmm end script",
                { chat: /^attacking with <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d20" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">([1-9]|[1-2][0-9])<\/span>$/ },
                { chat: /^rolled <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d20" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">([1-9]|[1-2][0-9])<\/span>, say again: <span class="mmm-highlight mmm-highlight-\1 showtip tipsy-n-right" title="Rolling 1d20" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">\2<\/span>, that is to say: <span class="mmm-highlight mmm-highlight-\1 showtip tipsy-n-right" title="Rolling 1d20" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">\2<\/span>$/ },
            ],
            [
                "!mmm script",
                "!mmm     set roll1 = [[1d1]]",
                "!mmm     set roll2 = [[2d1]]",
                "!mmm     chat: ${roll1}, ${roll2}",
                "!mmm end script",
                { chat: "<span class=\"mmm-highlight mmm-highlight-important showtip tipsy-n-right\" title=\"Rolling 1d1\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #4A57ED;font-weight:bold;font-size:1.1em;cursor:help\">1</span>, <span class=\"mmm-highlight mmm-highlight-important showtip tipsy-n-right\" title=\"Rolling 2d1\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #4A57ED;font-weight:bold;font-size:1.1em;cursor:help\">2</span>" },
            ],
            [
                "!mmm script",
                "!mmm    chat: attacking with [[1d3]]",
                "!mmm    set roll = $[[0]]",
                "!mmm    chat: critical: ${iscritical(roll)}",
                "!mmm    chat: fumble: ${isfumble(roll)}",
                "!mmm    chat: with custom tooltip: ${highlight(roll, default, 'custom tooltip for this roll')}",
                "!mmm end script",
                { chat: /^attacking with <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d3" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">[1-3]<\/span>$/ },
                { chat: /^critical: (true|false)$/ },
                { chat: /^fumble: (true|false)$/ },
                { chat: /^with custom tooltip: <span class=\"mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right\" title=\"custom tooltip for this roll\" style=\"padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1\.1em;cursor:help\">[1-3]<\/span>$/ },
            ],
            [
                "!mmm chat: broken critical: ${iscritical('not a roll')}",
                { chat: "broken critical: <span class=\"mmm-unknown showtip tipsy-n-right\" title=\"Roll result required\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold; cursor: help\">unknown</span>" },
                "!mmm chat: broken fumble: ${isfumble('not a roll')}",
                { chat: "broken fumble: <span class=\"mmm-unknown showtip tipsy-n-right\" title=\"Roll result required\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold; cursor: help\">unknown</span>" }
            ],
            [
                "!mmm combine chat",
                "!mmm    set roll = [[1d3]]",
                "!mmm    if iscritical(roll)",
                "!mmm        chat: critical",
                "!mmm    else if isfumble(roll)",
                "!mmm        chat: fumbled",
                "!mmm    else",
                "!mmm        chat: unremarkable",
                "!mmm    end if",
                "!mmm    chat: attack with ${roll}",
                "!mmm end combine",
                { chat: /^(critical|fumbled|unremarkable) attack with <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d3" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">[1-3]<\/span>$/ },
            ],
            [
                "!mmm chat: fumble: ${isfumble($[[0]])}, critical: ${iscritical($[[0]])}, roll: [[1d3]]",
                { chat: /^fumble: (true|false), critical: (true|false), roll: <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d3" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">[1-3]<\/span>$/ },
            ],
            [
                "!mmm script",
                "!mmm     chat: Going to attack...",
                "!mmm     set attackRoll = roll('1d20+12')",
                "!mmm     chat: Rolled attack ${attackRoll}",
                "!mmm     if attackRoll >= 20",
                "!mmm         chat: Success! Rolling damage...",
                "!mmm         set damageRoll = roll('1d6')",
                "!mmm         chat: Dealt ${damageRoll} points of damage",
                "!mmm     end if",
                "!mmm end script",
                { chat: "Going to attack..." },
                { process: "/roll 1d20+12" },
                { chat: /^Rolled attack <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d20\+12" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">([1-9]|[1-2][0-9]|3[0-2])<\/span>$/ },
                { chat: "Success! Rolling damage...", optional: true },
                { process: "/roll 1d6", optional: true },
                { chat: /^Dealt <span class="mmm-highlight mmm-highlight-(good|bad|normal) showtip tipsy-n-right" title="Rolling 1d6" style="padding:0 3px 0 3px;color:black;background-color:#FEF68E;border:2px solid #[0-9A-F]{6};font-weight:bold;font-size:1.1em;cursor:help">[1-6]<\/span> points of damage$/, optional: true },
            ],
            [
                "!mmm script",
                "!mmm     set undefResult = roll(undef)",
                "!mmm     chat: roll(undef) = ${undefResult}",
                "!mmm end script",
                { chat: "roll(undef) = <span class=\"mmm-unknown showtip tipsy-n-right\" title=\"Roll expression empty\" style=\"background: darkorange; border: 2px solid darkorange; color: white; font-weight: bold; cursor: help\">unknown</span>" },
            ],
            [
                "!mmm script",
                "!mmm     do roll('1d20')",
                "!mmm     do runtimeError()",
                "!mmm end script",
                { process: "/roll 1d20" },
                { error: "During execute, unknown function in expression in script: !mmm     do runtimeError‚ùå()" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: {{foo=" + "<br/>\n" +
                "!mmm         chat: bar" + "<br/>\n" +
                "!mmm         chat: baz}} quux",
                "!mmm     end combine",
                "!mmm end script",
                { chat: "{{foo= bar baz}} quux" },
            ],
            [
                "!mmm script",
                "!mmm     combine chat",
                "!mmm         chat: first paragraph",
                "!mmm         chat:",
                "!mmm         chat: second paragraph",
                "!mmm     end combine",
                "!mmm end script",
                { chat: "first paragraph <br/> second paragraph" },
            ],
            [
                "!mmm script",
                "!mmm     function cheer(message)",
                "!mmm         chat: Hark! ${message}, rejoice!",
                "!mmm     end function",
                "!mmm     do cheer('It works')",
                "!mmm     do cheer('And splendidly so')",
                "!mmm end script",
                { chat: "Hark! It works, rejoice!" },
                { chat: "Hark! And splendidly so, rejoice!" },
            ],
            [
                "!mmm script",
                "!mmm     function simon(says)",
                "!mmm         chat: ${script.who} says, ${says}",
                "!mmm     end function",
                "!mmm     set who = 'Finn'",
                "!mmm     do simon('it works!')",
                "!mmm     do simon('quite well.')",
                "!mmm     set who = 'Yorric'",
                "!mmm     do simon('I agree!')",
                "!mmm end script",
                { chat: "Finn says, it works!" },
                { chat: "Finn says, quite well." },
                { chat: "Yorric says, I agree!" },
            ],
            [
                "!mmm script",
                "!mmm     function multiplyAdd(a, b, c)",
                "!mmm         return (a * b) + c",
                "!mmm     end function",
                "!mmm     chat: ${multiplyAdd(1, 2, 3)}",
                "!mmm     chat: ${multiplyAdd(4, 5, 6)}",
                "!mmm end script",
                { chat: "5" },
                { chat: "26" },
            ],
            [
                "!mmm script",
                "!mmm     function test()",
                "!mmm         chat: correct",
                "!mmm         return",
                "!mmm         chat: broken",
                "!mmm     end function",
                "!mmm     do test()",
                "!mmm end script",
                { chat: "correct" },
            ],
            [
                "!mmm script",
                "!mmm     return",
                { error: "During parse, unexpected \"return\" outside of \"function\" block in script: !mmm ‚ùå    return" },
                "!mmm end script",
            ],
            [
                "!mmm script",
                "!mmm     function test()",
                "!mmm         chat: test",
                "!mmm     end function",
                "!mmm     do test()",
                "!mmm end script",
                { chat: "test" },
                "!mmm script",
                "!mmm     do test()",
                "!mmm end script",
                { error: "During execute, unknown function in expression in script: !mmm     do test‚ùå()" },
            ],
            [
                "!mmm script",
                "!mmm     do test()",
                "!mmm end script",
                { error: "During execute, unknown function in expression in script: !mmm     do test‚ùå()" },
                "!mmm function test()",
                "!mmm     chat: test 1",
                "!mmm end function",
                "!mmm script",
                "!mmm     do test()",
                "!mmm end script",
                { chat: "test 1" },
                "!mmm function test()",
                "!mmm     chat: test 2",
                "!mmm end function",
                "!mmm script",
                "!mmm     do test()",
                "!mmm end script",
                { chat: "test 2" },
            ],
            [
                "!mmm function test(foo, broken!, bar)",
                { error: "During parse, syntax error in script: !mmm function test(foo, broken‚ùå!, bar)" },
            ],
            [
                "!mmm function test(foo, bar,)",
                { error: "During parse, syntax error in script: !mmm function test(foo, bar‚ùå,)" },
            ],
            [
                "!mmm function test(foo,, bar)",
                { error: "During parse, syntax error in script: !mmm function test(foo‚ùå,, bar)" },
            ],
            [
                "!mmm function test1()",
                "!mmm     do test2()",
                "!mmm end function",
                "!mmm function test2()",
                "!mmm     do test3()",
                "!mmm end function",
                "!mmm function test3()",
                "!mmm     do runtimeError()",
                "!mmm end function",
                "!mmm do test1()",
                { error: "During execute, unknown function in expression in script: !mmm     do runtimeError‚ùå()\nCalled from: !mmm     do ‚ùåtest3()\nCalled from: !mmm     do ‚ùåtest2()\nCalled from: !mmm do ‚ùåtest1()" },
            ],
            [
                "!mmm customize",
                "!mmm     set meep = 'moop'",
                "!mmm     translate [foo]: Bar $[number]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     chat [foo]: Foo $[number]{1}",
                "!mmm     function test()",
                "!mmm         set customizable meep",
                "!mmm         chat: ${meep} ${meep}",
                "!mmm         chat [foo]: Foo $[number]{2}",
                "!mmm     end function",
                "!mmm     do test()",
                "!mmm     chat [foo]: Foo $[number]{3}",
                "!mmm end script",
                { chat: "Bar 1" },
                { chat: "moop moop" },
                { chat: "Bar 2" },
                { chat: "Bar 3" },
            ],
            [
                "!mmm function test()",
                "!mmm     chat [foo]: Foo $[number]{1}",
                "!mmm end function",
                "!mmm customize",
                "!mmm     translate [foo]: Bar $[number]",
                "!mmm end customize",
                "!mmm do test()",
                { chat: "Bar 1" },
            ],
            [
                "!mmm function test()",
                "!mmm     chat: ${script.foo}",
                "!mmm end function",
                "!mmm script",
                "!mmm     set foo = 'correct'",
                "!mmm     do test()",
                "!mmm end script",
                { chat: "correct" },
            ],
            [
                "!mmm function test1()",
                "!mmm     chat: test 1",
                "!mmm     do test2()",
                "!mmm end function",
                "!mmm function test2()",
                "!mmm     chat: test 2",
                "!mmm     do script.test3()",
                "!mmm end function",
                "!mmm script",
                "!mmm     function test3()",
                "!mmm         chat: test 3",
                "!mmm     end function",
                "!mmm     do test1()",
                "!mmm end script",
                { chat: "test 1" },
                { chat: "test 2" },
                { chat: "test 3" },
            ],
            [
                "!mmm chat: ${floor}",
                { chat: "floor(param1)" },
            ],
            [
                "!mmm function test0()",
                "!mmm end function",
                "!mmm chat: ${test0}",
                { chat: "test0()" },
            ],
            [
                "!mmm function test1(foo)",
                "!mmm end function",
                "!mmm chat: ${test1}",
                { chat: "test1(foo)" },
            ],
            [
                "!mmm function test3(foo, bar, baz)",
                "!mmm end function",
                "!mmm chat: ${test3}",
                { chat: "test3(foo, bar, baz)" },
            ],
            [
                "!mmm debug do floor",
                { whisper: "üîé <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>floor(param1)</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>floor</span>" },
            ],
            [
                "!mmm function test3(foo, bar, baz)",
                "!mmm end function",
                "!mmm debug do test3",
                { whisper: "üîé <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>test3(foo, bar, baz)</span> ‚óÄÔ∏è <span style='background: #E0E0E0; padding: 0em 0.3em; border: 2px solid silver; border-radius: 0.5em; color: black; white-space: pre-wrap'>test3</span>" },
            ],
            [
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: broken, foo=${foo}",
                "!mmm end script",
                { error: "During execute, require customization or default in script: !mmm     set customizable foo‚ùå" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'broken'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm     set asyncOperation = roll('1d20')",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { process: "/roll 1d20" },
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = default",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm end script",
                { chat: "correct, foo=correct, bar=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm end script",
                { chat: "correct, foo=correct, bar=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm status",
                { whisper: /player1234.*Seen.*Context.*Script.*customize, customize, script \[set, set, chat, \.\.\.\].*Error/ },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm syntax error",
                { error: "During parse, unknown command in script: !mmm ‚ùåsyntax error" },
                "!mmm customize",
                "!mmm     set bar = 'correct'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     set customizable bar",
                "!mmm     chat: correct, foo=${foo}, bar=${bar}",
                "!mmm end script",
                { chat: "correct, foo=correct, bar=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm     syntax error",
                { error: "During parse, unknown command in script: !mmm     ‚ùåsyntax error" },
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm     syntax error",
                { error: "During parse, unknown command in script: !mmm     ‚ùåsyntax error" },
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'correct'",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm     do runtimeError()",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { whisper: "During customize, unknown function in expression in script: !mmm     do runtimeError‚ùå()" },
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm customize",
                "!mmm     set foo = 'broken'",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable foo",
                "!mmm     chat: broken",
                "!mmm script",
                "!mmm     set customizable foo = 'correct'",
                "!mmm     chat: correct, foo=${foo}",
                "!mmm end script",
                { chat: "correct, foo=correct" },
            ],
            [
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{meaning*2}, thrice is ${meaning*3}",
                "!mmm end script",
                { chat: "meaning is 42, twice the meaning is 84, thrice is 126" },
            ],
            [
                "!mmm customize",
                "!mmm     translate [foo]: correct foo translation",
                "!mmm end customize",
                "!mmm customize",
                "!mmm     translate [bar]: correct bar translation",
                "!mmm end customize",
                "!mmm script",
                "!mmm     chat [foo]: broken foo",
                "!mmm     chat [bar]: broken bar",
                "!mmm end script",
                { chat: "correct foo translation" },
                { chat: "correct bar translation" },
            ],
            [
                "!mmm customize",
                "!mmm     translate [foo]: Bedeutung is $[once], doppelte Bedeutung ist $[twice], und sonst $[gibtsnich]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{meaning*2}, thrice is ${meaning*3}",
                "!mmm end script",
                { chat: "Bedeutung is 42, doppelte Bedeutung ist 84, und sonst $[gibtsnich]" },
            ],
            [
                "!mmm customize",
                "!mmm     set meaning = 123",
                "!mmm     translate [foo]: Bedeutung is $[once], doppelte Bedeutung ist $[twice], aber $[once]{meaning} ist unbedeutend",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{meaning*2}, thrice is ${meaning*3}",
                "!mmm end script",
                { chat: "Bedeutung is 42, doppelte Bedeutung ist 84, aber 123 ist unbedeutend" },
            ],
            [
                "!mmm customize",
                "!mmm     translate [foo]: Bedeutung is $[once], doppelte Bedeutung ist $[twice]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set meaning = 42",
                "!mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{runtimeError()*2}, thrice is ${meaning*3}",
                "!mmm end script",
                { error: "During execute, unknown function in expression in template in script: !mmm     chat [foo]: meaning is $[once]{meaning}, twice the meaning is $[twice]{runtimeError‚ùå()*2}, thrice is ${meaning*3}" },
            ],
            [
                "!mmm customize",
                "!mmm     set customizedSetting = 'correct ' & '\"customized\"' & ' setting'",
                "!mmm     translate [translatedChat]: correct translated chat message with $[correct_placeholder]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable customizedSetting = 'broken'",
                "!mmm     set customizable settingWithConstantDefault = 'correct ' & '\"default\"' & ' setting'",
                "!mmm     set customizable settingWithVariableDefault = 'correct ' & '\"default\"' & ' setting' & variable",
                "!mmm     chat [translatedChat]: broken translated chat with $[correct_placeholder]{'correct labeled expression'}",
                "!mmm     chat [defaultChat]: correct default chat with $[broken_placeholder]{'correct labeled expression'} and ${'correct expression without label'} and $[correct_misplaced_label]",
                "!mmm     chat [defaultChat]: correct redundant default chat with $[broken_placeholder]{'correct labeled expression'} and ${'correct expression without label'} and $[correct_misplaced_label]",
                "!mmm end script",
                { chat: "correct translated chat message with correct labeled expression" },
                { chat: "correct default chat with correct labeled expression and correct expression without label and $[correct_misplaced_label]" },
                { chat: "correct redundant default chat with correct labeled expression and correct expression without label and $[correct_misplaced_label]" },
            ],
            [
                "!mmm customize export to chat",
                "!mmm customize",
                "!mmm     set customizedSetting = 'correct ' & '\"customized\"' & ' setting'",
                "!mmm     translate [translatedChat]: correct translated chat message with $[correct_placeholder]",
                "!mmm end customize",
                "!mmm script",
                "!mmm     set customizable customizedSetting = 'broken'",
                "!mmm     set customizable settingWithoutDefault",
                "!mmm     set customizable settingWithConstantDefault = 'correct ' & '\"default\"' & ' setting'",
                "!mmm     set customizable settingWithVariableDefault = 'correct ' & '\"default\"' & ' setting' & variable",
                "!mmm     chat [translatedChat]: broken translated chat with $[correct_placeholder]{'labeled expression'}",
                "!mmm     chat [defaultChat]: correct default chat with $[correct_placeholder]{'broken labeled expression'} and ${'broken expression without label'} and $[correct_misplaced_label]",
                "!mmm     chat [defaultChat]: broken redundant default chat with $[broken_placeholder]{'broken labeled expression'} and ${'broken expression without label'} and $[broken_misplaced_label]",
                "!mmm end script",
                { whisper: "<span style='white-space: pre'>!mmm customize<br/>" +
                           "!mmm    set customizedSetting = \"correct \\\"customized\\\" setting\"<br/>" +
                           "!mmm    set settingWithoutDefault = ü§î<br/>" +
                           "!mmm    set settingWithConstantDefault = \"correct \\\"default\\\" setting\"<br/>" +
                           "!mmm    set settingWithVariableDefault = default<br/>" +
                           "!mmm    translate [translatedChat]: correct translated chat message with $[correct_placeholder]<br/>" +
                           "!mmm    translate [defaultChat]: correct default chat with $[correct_placeholder] and ... and $[correct_misplaced_label]<br/>" +
                           "!mmm end customize</span>" },
            ],
            [
                "!mmm customize export to chat",
                "!mmm script",
                "!mmm     chat: no label",
                "!mmm end script",
                { whisper: "<span style='white-space: pre'>!mmm customize<br/>" +
                           "!mmm end customize</span>" },
            ],
            [
                "!mmm customize export to chat",
                "!mmm script",
                "!mmm     set not_customizable = 123",
                "!mmm end script",
                { whisper: "<span style='white-space: pre'>!mmm customize<br/>" +
                           "!mmm end customize</span>" },
            ],
        ];

        let processes = [];

        let attributes =
        {
            Finn:
            {
                name: { current: "Finn MacRathgar" },
                HP: { current: 20, max: 30 },
                LP: { current: 15, max: 25 },
                cousin: { current: "Yorrick" },
            },
            Yorrick:
            {
                name: { current: "Yorrick MacRathgar" },
                HP: { current: 18, max: 28 },
                LP: { current: 13, max: 23 },
                cousin: { current: "Finn" },
            },
        };

        MychScriptContext.prototype.listnum = function(list)
        {
            if (list instanceof MychExpressionArgs)
            {
                console.log("Require list, got", list);
                return new MychScriptContext.Unknown("Require list, got args");
            }

            if (Array.isArray(list))
            {
                return list.length;
            }
            
            console.log("Require list, got", list);
            return new MychScriptContext.Unknown("Require list, got " + typeof(list));
        }

        MychScriptContext.prototype.listidx = function(list, index)
        {
            if (list instanceof MychExpressionArgs)
            {
                console.log("Require list, got", list);
                return new MychScriptContext.Unknown("Require list, got args");
            }

            if (Array.isArray(list))
            {
                if (index >= list.length)
                {
                    console.log("Require valid index into", list, "got", index);
                    return new MychScriptContext.Unknown("Require index less or equal " + (list.length - 1) + ", got " + index);
                }

                return list[index];
            }
            
            console.log("Require list, got", list);
            return new MychScriptContext.Unknown("Require list, got " + typeof(list));
        }

        MychScriptContext.prototype.whisperback = function(message)
        {
            processes.push(
            {
                type: "whisper",
                message: MychExpression.coerceString(message),
            });
        };

        MychScriptContext.prototype.error = function(exception)
        {
            console.log(exception);

            processes.push(
            {
                type: "error",
                message: escapeHTML(exception),
            });
        };

        MychScriptContext.prototype.$getAttribute = function(characterNameOrId, attributeName, max = false)
        {
            if (characterNameOrId instanceof MychScriptContext.DiagnosticUndef)
            {
                return characterNameOrId;
            }

            if (attributeName instanceof MychScriptContext.DiagnosticUndef)
            {
                return attributeName;
            }

            characterNameOrId = MychExpression.coerceString(characterNameOrId);

            let attributesForCharacter = attributes[characterNameOrId];

            if (!attributesForCharacter)
            {
                return new MychScriptContext.Unknown("Unknown character: " + characterNameOrId);
            }

            attributeName = MychExpression.coerceString(attributeName);
            
            let attribute = attributesForCharacter[attributeName];

            if (!attribute)
            {
                return new MychScriptContext.Unknown("Unknown attribute: " + attributeName);
            }

            return MychExpression.coerceString(max ? attribute.max : attribute.current);
        }

        MychScriptContext.prototype.getattr = function(characterNameOrId, attributeName)
        {
            return this.$getAttribute(characterNameOrId, attributeName, false);
        }

        MychScriptContext.prototype.getattrmax = function(characterNameOrId, attributeName)
        {
            return this.$getAttribute(characterNameOrId, attributeName, true);
        }

        MychScriptContext.prototype.$setAttribute = function(characterNameOrId, attributeName, attributeValue, max = false)
        {
            if (characterNameOrId instanceof MychScriptContext.DiagnosticUndef)
            {
                return characterNameOrId;
            }

            if (attributeName instanceof MychScriptContext.DiagnosticUndef)
            {
                return attributeName;
            }

            characterNameOrId = MychExpression.coerceString(characterNameOrId);

            let attributesForCharacter = attributes[characterNameOrId];

            if (!attributesForCharacter)
            {
                return new MychScriptContext.Unknown("Unknown character: " + characterNameOrId);
            }

            attributeName = MychExpression.coerceString(attributeName);
            attributeValue = MychExpression.coerceString(attributeValue);

            let attribute = attributesForCharacter[attributeName];

            if (!attribute)
            {
                attribute = { current: undefined, max: undefined };
                attributesForCharacter[attributeName] = attribute;
            }

            attribute[max ? "max" : "current"] = MychExpression.coerceString(attributeValue);

            return this.$getAttribute(characterNameOrId, attributeName, max);
        }

        MychScriptContext.prototype.setattr = function(characterNameOrId, attributeName, attributeValue)
        {
            return this.$setAttribute(characterNameOrId, attributeName, attributeValue, false);
        }

        MychScriptContext.prototype.setattrmax = function(characterNameOrId, attributeName, attributeValue)
        {
            return this.$setAttribute(characterNameOrId, attributeName, attributeValue, true);
        }

        function playerIsGM(playerid)
        {
            return /^gm/.test(playerid);
        }

        function getObj(type, id)
        {
            return undefined;
        }

        function findObjs(props)
        {
            return [];
        }

        function sendChat(sender, message, callback, options)
        {
            let results = [];

            let rollRegExp = /^\/roll\s+(?<expression>.+)/i;
            let rollMatch = rollRegExp.exec(message);

            if (rollMatch)
            {
                let rollExpression = rollMatch.groups.expression;
                let rollResults = executeRoll(rollExpression);

                results.push({ who: sender, type: "rollresult", content: JSON.stringify(rollResults), origRoll: rollExpression });
            }
            else
            {
                results.push({ who: sender, type: "general", content: message });
            }

            if (callback)
            {
                let sendChatProcess = function()
                {
                    callback(results);
                }

                processes.push(
                {
                    type: "process",
                    message: message,
                    execute: sendChatProcess,
                });
            }
            else
            {
                processes.push(
                {
                    type: "chat",
                    message: message,
                });
            }
        }

        function executeRoll(rollExpression)
        {
            let rollExpressionRegExp = /^(?<numDice>\d+)?d(?<numSides>\d+)(?<modifier>[-+]\d+)?$/i;
            let rollExpressionMatch = rollExpressionRegExp.exec(rollExpression);

            if (!rollExpressionMatch)
            {
                return undefined;
            }

            let numDice = parseInt(rollExpressionMatch.groups.numDice || 1);
            let numSides = parseInt(rollExpressionMatch.groups.numSides);
            let modifier = parseInt(rollExpressionMatch.groups.modifier || 0)

            let rollResults = 
            {
                rolls:
                [
                    {
                        type: "R",
                        dice: numDice,
                        sides: numSides,
                        results: [],
                    },
                ],
                total: 0,
            };

            for (; numDice > 0; --numDice)
            {
                let rollValue = Math.floor(Math.random() * numSides) + 1;
                
                rollResults.rolls[0].results.push({ v: rollValue });
                rollResults.total += rollValue;
            }

            if (modifier)
            {
                rollResults.rolls.push({ type: "M", expr: rollExpressionMatch.groups.modifier });
                rollResults.total += modifier;
            }

            return rollResults;
        }

        let numTestsRun = 0;
        let numTestsSuccessful = 0;
        let testsFailed = [];

        MychScriptContext.running = true;

        let contextStatics = Object.fromEntries(Object.entries(MychScriptContext).filter(([key, value]) => !(value instanceof Function)));

        for (let scriptSourceIndex = 0; scriptSourceIndex < scriptSources.length; ++scriptSourceIndex)
        {
            if (includedScriptSources.length > 0 && !includedScriptSources.includes(scriptSourceIndex))
            {
                continue;
            }

            let scriptSource = scriptSources[scriptSourceIndex];

            document.write("<div class='script'>");
            document.write("<table>");
            document.write("<tr><td></td><td class='script-header'>test script " + scriptSourceIndex + "</td></tr>");

            for (let [contextStaticName, contextStaticValue] of Object.entries(contextStatics))
            {
                let contextStaticValueClone = contextStaticValue;

                if (contextStaticValueClone instanceof Object)
                {
                    contextStaticValueClone = Object.create(Object.getPrototypeOf(contextStaticValue));
                    Object.assign(contextStaticValueClone, contextStaticValue);
                }

                MychScriptContext[contextStaticName] = contextStaticValueClone;
            }

            let msgOverrides = {};

            let testSuccessful = true;

            for (let scriptSourceLineIndex = 0, scriptSourceLineNumber = 1; scriptSourceLineIndex < scriptSource.length; ++scriptSourceLineIndex, ++scriptSourceLineNumber)
            {
                let scriptSourceLine = scriptSource[scriptSourceLineIndex];
                let scriptSourceRolls = [];

                let originalScriptSourceLine = scriptSourceLine;

                scriptSourceLine = scriptSourceLine.replace(/\[\[([^\]]*[^\d\]][^\]]*)\]\]/gi,
                    function(substring, rollExpression)
                    {
                        scriptSourceRolls.push(
                        {
                            expression: rollExpression,
                            results: executeRoll(rollExpression),
                        });

                        return "$[[" + (scriptSourceRolls.length - 1) + "]]";
                    });

                document.write("<tr>");
                
                document.write("<td class='lineno'>");
                document.write(scriptSourceLineNumber);
                document.write("</td>");

                document.write("<td>");
                document.write(escapeHTML(scriptSourceLine));

                if (scriptSourceLine != originalScriptSourceLine)
                {
                    document.write(" <span class='original'>" + escapeHTML(originalScriptSourceLine.trim()) + "</span>")
                }

                document.write("</td>");
                document.write("</tr>");

                let expectedProcessOutputs = [];

                while (scriptSource[scriptSourceLineIndex + 1] instanceof Object)
                {
                    expectedProcessOutputs.push(scriptSource[++scriptSourceLineIndex]);
                }

                let msg =
                {
                    type: "api",
                    playerid: "player1234",
                    who: "Tester",
                    content: scriptSourceLine,
                    inlinerolls: scriptSourceRolls,
                };

                Object.assign(msg, msgOverrides);

                let testCommandRegExp = /^\/test\s+(?<command>\w+)\s+(?<args>.+?)\s*$/u;
                let testCommandMatch = testCommandRegExp.exec(msg.content);

                if (testCommandMatch)
                {
                    let testCommandName = testCommandMatch.groups.command;
                    let testCommandArgs = testCommandMatch.groups.args;

                    switch (testCommandName)
                    {
                        case "impersonate":
                        {
                            msgOverrides.playerid = testCommandArgs;
                            processes.push(
                            {
                                type: "harness",
                                message: "Impersonating " + msgOverrides.playerid,
                            });
                        }
                        break;

                        default:
                        {
                            processes.push(
                            {
                                type: "error",
                                message: "Unknown test command: " + testCommandName,
                            });
                        }
                        break;
                    }
                }

                eventHandlers["chat:message"](msg);

                while (processes.length > 0)
                {
                    let process = processes.shift();

                    let expectedProcessOutput = expectedProcessOutputs.shift();
                    let expectedProcessOutputSatisfied = false;
                    let expectedProcessType;
                    let expectedProcessMessage;

                    let receivedProcessType = process.type;
                    let receivedProcessMessage = normalizeHTML(process.message);

                    if (expectedProcessOutput)
                    {
                        [expectedProcessType, expectedProcessMessage] = Object.entries(expectedProcessOutput)[0];

                        if (receivedProcessType == expectedProcessType)
                        {
                            if (expectedProcessMessage instanceof RegExp)
                            {
                                expectedProcessOutputSatisfied = expectedProcessMessage.exec(receivedProcessMessage);
                            }
                            else if (expectedProcessMessage == undefined)
                            {
                                expectedProcessOutputSatisfied = true;
                            }
                            else
                            {
                                expectedProcessMessage = normalizeHTML(expectedProcessMessage);
                                expectedProcessOutputSatisfied = (expectedProcessMessage == receivedProcessMessage);
                            }
                        }
                    }

                    if (expectedProcessOutputSatisfied)
                    {
                        document.write("<tr class='ok'>");
                        document.write("<td class='lineno'>" + receivedProcessType + "</td>");
                        document.write("<td class='output'>" + receivedProcessMessage + "</td>");
                        document.write("</tr>");
                    }
                    else
                    {
                        testSuccessful = false;

                        document.write("<tr class='unexpected'>");
                        document.write("<td class='lineno'>" + receivedProcessType + "</td>");
                        document.write("<td class='output'>" + receivedProcessMessage + "</td>");
                        document.write("</tr>");

                        console.log("received:", JSON.stringify({ [receivedProcessType]: receivedProcessMessage }));

                        if (expectedProcessOutput)
                        {
                            if (expectedProcessMessage instanceof RegExp)
                            {
                                expectedProcessMessage = escapeHTML(expectedProcessMessage);
                            }

                            document.write("<tr class='expected'>");
                            document.write("<td class='lineno'>" + expectedProcessType + "</td>");
                            document.write("<td class='output'>" + expectedProcessMessage + "</td>");
                            document.write("</tr>");

                            console.log("expected:", JSON.stringify({ [expectedProcessType]: expectedProcessMessage }));
                        }
                    }

                    if (process.execute)
                    {
                        process.execute();
                    }
                }

                for (let expectedProcessOutput of expectedProcessOutputs)
                {
                    if (expectedProcessOutput.optional)
                    {
                        continue;
                    }
                    
                    testSuccessful = false;

                    let [expectedProcessType, expectedProcessMessage] = Object.entries(expectedProcessOutput)[0];

                    if (expectedProcessMessage instanceof RegExp)
                    {
                        expectedProcessMessage = escapeHTML(expectedProcessMessage);
                    }

                    document.write("<tr class='expected'>");
                    document.write("<td class='lineno'>" + expectedProcessType + "</td>");
                    document.write("<td class='output'>" + expectedProcessMessage + "</td>");
                    document.write("</tr>");

                    console.log("expected:", JSON.stringify({ [expectedProcessType]: expectedProcessMessage }));
                }

                expectedProcessOutputs.length = 0;
            }

            document.write("</table>");
            document.write("</div>");

            numTestsRun += 1;
            numTestsSuccessful += (testSuccessful ? 1 : 0);

            if (!testSuccessful)
            {
                testsFailed.push(scriptSourceIndex);
            }
        }

        if (numTestsSuccessful == numTestsRun)
        {
            document.write("<div class='results-success'>");
            document.write("Success: Ran " + numTestsRun + " test scripts, all successful.");
            document.write("</div>");
        }
        else
        {
            document.write("<div class='results-failure'>");
            document.write("Failed: Ran " + numTestsRun + " test scripts, " + (numTestsRun - numTestsSuccessful) + " failed (script index " + testsFailed.join(", ") + ")");
            document.write("</div>");
        }
    </script>
</body>
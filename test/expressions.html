<!DOCTYPE HTML>
<head>
    <title>
        Expression Tests &ndash; Mych's Macro Magic
    </title>
    <script>
        eventHandlers = {};

        function on(eventName, eventHandler)
        {
            eventHandlers[eventName] = eventHandler;
        }
    </script>
    <script src="../MychsMacroMagic.js">
    </script>
    <script>
        function escapeHTML(text)
        {
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function stripHTML(html)
        {
            return String(html).replace(/<[^>]*>/g, "").replace(/&#(\d+);/g, (_, codePoint) => String.fromCodePoint(parseInt(codePoint)));
        }
    </script>
    <style type="text/css">
        body {
            font-family: Consolas, monospace;
            font-size: 9pt;
            line-height: 13pt;
        }

        div.expression {
            padding: 0.5em 1em 1em 1em;
            border: 1px solid silver;
            margin-bottom: 1em;
            white-space: pre-wrap;
        }

        #results-container {
            margin-bottom: 8pt;
        }

        div.results-success {
            padding: 0.5em 1em;
            border: 1px solid gray;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 12pt;
            color: green;
            background: #C0FFC0;
        }

        div.results-failure {
            padding: 0.5em 1em;
            border: 1px solid gray;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 12pt;
            color: red;
            background: #FFC0C0;
        }

        div.results-failure a {
            color: inherit;
            text-decoration: none;
        }

        div.results-failure a:hover {
            text-decoration: underline;
        }

        div.results-failure button {
            margin-top: 5pt;
        }

        table {
            table-layout: fixed;
        }

        td.expression-header {
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 10pt;
            padding-bottom: 0.5em;
        }

        td.lineno {
            width: 3em;
            color: gray;
            font-family: Calibri, sans-serif;
            text-align: right;
            padding-right: 1em;
        }

        tr.token-header {
            color: gray;
            font-family: Calibri, sans-serif;
        }

        tr.token-header td {
            padding-top: 8pt;
        }

        tr.token td.token-source {
            width: 20em;
            border-top: 1px solid #E8E8E8;
        }

        tr.token td.token-type {
            width: 20em;
            font-family: Calibri, sans-serif;
            border-top: 1px solid #E8E8E8;
        }

        tr.token td.rule-name {
            width: 20em;
            font-family: Calibri, sans-serif;
            border-top: 1px solid #E8E8E8;
        }

        tr.token td.group {
            width: 5em;
            font-family: Calibri, sans-serif;
            border-top: 1px solid #E8E8E8;
        }

        tr.token td.evaluation {
            padding-right: 1.5em;
            font-family: Calibri, sans-serif;
            border-top: 1px solid #E8E8E8;
        }

        tr.token td.evaluation.constant {
            color: #C0C0C0;
        }

        td.output.debug {
            font-family: Calibri, sans-serif;
            white-space: pre-wrap;
        }

        td.output.error {
            font-family: Calibri, sans-serif;
            white-space: pre-wrap;
        }

        td.output.yield {
            white-space: pre-wrap;
        }

        td.output.result {
            white-space: pre-wrap;
        }

        tr.ok td.output {
            color: green;
        }

        tr.unexpected td {
            color: red;
        }

        tr.expected td {
            background: yellow;
        }
    </style>
</head>
<body>
    <div id="results-container"></div>

    <script>
        let includedExpressionSources = [];

        let expressionSources =
        [
            [
                "version",
                { result: MychExpression.literal(MMM_VERSION) },
            ],
            [
                "1 + 2 * 3",
                { result: "7" },
            ],
            [
                "(1 + 2) * 3",
                { result: "9" },
            ],
            [
                "1 + .5",
                { result: "1.5" },
            ],
            [
                "1 + .prop",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: 1 + ❌.prop" }
            ],
            [
                "strlen('ookook')",
                { result: "6" },
            ],
            [
                "(1 == 1)",
                { result: "true" },
            ],
            [
                "(1 == 2)",
                { result: "false" },
            ],
            [
                "(1 == 1) and (2 != 3)",
                { result: "true" },
            ],
            [
                "1 + ()",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: 1 + (❌)" },
            ],
            [
                "1 * ()",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: 1 * (❌)" },
            ],
            [
                "3 * (() + 2)",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: 3 * ((❌) + 2)" },
            ],
            [
                "2 ** 8",
                { result: "256" },
            ],
            [
                "2 ** 2 ** 3",
                { result: "256" },
            ],
            [
                "list12, list345",
                { result: "(1, 2, 3, 4, 5)" },
            ],
            [
                "list12[]",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: list12[❌]" },
            ],
            [
                "list12[0] + list345[1 + 1]",
                { result: "6" },
            ],
            [
                "list12[0][1]",
                { error: "During parse, expected binary operator, or property lookup, or three dots (to get list of property key-value pairs), or end of expression in expression: list12[0]❌[1]" },
            ],
            [
                "list12[0)",
                { error: "During parse, expected binary operator, or colon (between property key and its value), or property lookup, or closing bracket in expression: list12[0❌)" },
            ],
            [
                "(11, 22, 33)[2]",
                { result: "33" },
            ],
            [
                "list345 select ... + 1",
                { result: "(4, 5, 6)" },
            ],
            [
                "list345 select (..., ...)",
                { result: "(3, 3, 4, 4, 5, 5)" },
            ],
            [
                "list345 select ..., ...",
                { result: "(3, 4, 5, \"anonymous!\")" },
            ],
            [
                "list345 where ... < 3",
                { result: "undef" },
            ],
            [
                "list345 where ... < 4",
                { result: "3" },
            ],
            [
                "list345 where ... < 5",
                { result: "(3, 4)" },
            ],
            [
                "list345 where true",
                { result: "(3, 4, 5)" },
            ],
            [
                "(22, 33, 44) where ... % 2 == 0",
                { result: "(22, 44)" },
            ],
            [
                "list345 select ... + 10 where ... < 15",
                { result: "(13, 14)" },
            ],
            [
                "list345 where ... < 5 select ... + 10",
                { result: "(13, 14)" },
            ],
            [
                "args()",
                { result: "undef" },
            ],
            [
                "args(())",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: args((❌))" },
            ],
            [
                "args(1)",
                { result: "arg0: 1" },
            ],
            [
                "args(1, 'two', 3, 'four')",
                { result: "(arg0: 1, arg1: \"two\", arg2: 3, arg3: \"four\")" },
            ],
            [
                "args(list12, list345)",
                { result: "(arg0: (1, 2), arg1: (3, 4, 5))" },
            ],
            [
                "args((1, 'two'), (3, 'four'))",
                { result: "(arg0: 1, arg1: \"two\", arg2: 3, arg3: \"four\")" },
            ],
            [
                "argnum()",
                { result: "0" },
            ],
            [
                "argnum(1, 2, 3, 4)",
                { result: "4" },
            ],
            [
                "argnum(1, (2, 3, 4))",
                { result: "4" },
            ],
            [
                "argnum((1, 2, 3), 4)",
                { result: "4" },
            ],
            [
                "argnum((1, 2), (3, 4))",
                { result: "4" },
            ],
            [
                "argnum(list345)",
                { result: "1" },
            ],
            [
                "argnum(1, list345)",
                { result: "2" },
            ],
            [
                "argnum(list345, 2)",
                { result: "2" },
            ],
            [
                "argnum(1, list345, 2)",
                { result: "3" },
            ],
            [
                "listnum(arg1(1, list345, 2))",
                { result: "3" },
            ],
            [
                "argnum(undef)",
                { result: "1" },
            ],
            [
                "argnum(1, undef)",
                { result: "2" },
            ],
            [
                "argnum(undef, 2)",
                { result: "2" },
            ],
            [
                "argnum(1, undef, 2)",
                { result: "3" },
            ],
            [
                "argnum(denied)",
                { result: "1" },
            ],
            [
                "argnum(1, denied)",
                { result: "2" },
            ],
            [
                "argnum(denied, 2)",
                { result: "2" },
            ],
            [
                "argnum(1, denied, 2)",
                { result: "3" },
            ],
            [
                "isdenied(arg1(1, denied, 2))",
                { result: "true" },
            ],
            [
                "argnum(unknown)",
                { result: "1" },
            ],
            [
                "argnum(1, unknown)",
                { result: "2" },
            ],
            [
                "argnum(unknown, 2)",
                { result: "2" },
            ],
            [
                "argnum(1, unknown, 2)",
                { result: "3" },
            ],
            [
                "isunknown(arg1(1, unknown, 2))",
                { result: "true" },
            ],
            [
                "argnum(default)",
                { result: "1" },
            ],
            [
                "argnum(1, default)",
                { result: "2" },
            ],
            [
                "argnum(default, 2)",
                { result: "2" },
            ],
            [
                "argnum(1, default, 2)",
                { result: "3" },
            ],
            [
                "isdefault(arg1(1, default, 2))",
                { result: "true" },
            ],
            [
                "foo: 123",
                { result: "foo: 123" },
            ],
            [
                "foo: 123 + 456",
                { result: "foo: 579" },
            ],
            [
                "1 + foo: 123 + 456",
                { result: "580" },
            ],
            [
                "not not foo: 1 == 1",
                { result: "true" },
            ],
            [
                "not not foo: 1 != 1",
                { result: "false" },
            ],
            [
                "(foo: 123, bar: 456) select ...key",
                { result: "(\"foo\", \"bar\")" },
            ],
            [
                "(foo: 123, bar: 456) select ...value",
                { result: "(123, 456)" },
            ],
            [
                "((foo: true, bar: false) where ...).key",
                { result: "\"foo\"" },
            ],
            [
                "((foo: true, bar: false) where not ...).key",
                { result: "\"bar\"" },
            ],
            [
                "(foo: 123).key",
                { result: "\"foo\"" },
            ],
            [
                "(foo: 123).value",
                { result: "123" },
            ],
            [
                "(foo: bar: 123).key",
                { result: "\"foo\"" },
            ],
            [
                "(foo: bar: 123).value",
                { result: "bar: 123" },
            ],
            [
                "(foo: bar: 123).value.key",
                { result: "\"bar\"" },
            ],
            [
                "(foo: bar: 123).value.value",
                { result: "123" },
            ],
            [
                "('f' & 'oo'): 123",
                { result: "foo: 123" },
            ],
            [
                "('Char1'.HP): 123",
                { result: "\"15\": 123" },
            ],
            [
                "{('Char1'.HP): 123}",
                { result: "{\"15\": 123}" },
            ],
            [
                "'foo': 123",
                { result: "foo: 123" },
            ],
            [
                "123.0: 456",
                { result: "\"123\": 456" },
            ],
            [
                "true: 123",
                { result: "true: 123" },
            ],
            [
                "list12[0]: 123",
                { error: "During parse, expected binary operator, or property lookup, or three dots (to get list of property key-value pairs), or end of expression in expression: list12[0]❌: 123" },
            ],
            [
                "{}.foo",
                { result: "undef" },
            ],
            [
                "{foo: 123, bar: 456}",
                { result: "{bar: 456, foo: 123}" },
            ],
            [
                "{foo: 123, bar: 456}.foo",
                { result: "123" },
            ],
            [
                "{foo: 123, bar: 456}.bar",
                { result: "456" },
            ],
            [
                "{foo: 123, bar: 456}.baz",
                { result: "undef" },
            ],
            [
                "{{foo: 123}, {bar: 456}}",
                { result: "{bar: 456, foo: 123}" },
            ],
            [
                "{{foo: 123, bar: 456}, foo: 789}",
                { result: "{bar: 456, foo: 789}" },
            ],
            [
                "{{foo: 123, bar: 456}, 789}",
                { result: "{\"\": 789, bar: 456, foo: 123}" },
            ],
            [
                "0 + {foo: 123, bar: 456}",
                { result: "2" },
            ],
            [
                "{foo: 123, bar: 456, baz: 789}...",
                { result: "(bar: 456, baz: 789, foo: 123)" },
            ],
            [
                "(foo: 123, bar: 456, baz: 789)...",
                { result: "(foo: 123, bar: 456, baz: 789)" },
            ],
            [
                "({foo: 123, bar: 456}, baz: 789)...",
                { result: "(bar: 456, foo: 123, baz: 789)" },
            ],
            [
                "{{foo: 123, bar: 456, baz: 789}... where ...value > 234}",
                { result: "{bar: 456, baz: 789}" },
            ],
            [
                "{{foo: 123, bar: 456, baz: 789}... where ...key ne 'baz'}",
                { result: "{bar: 456, foo: 123}" },
            ],
            [
                "{('foo', 'bar', 'baz') select (...: ... & '!')}",
                { result: "{bar: \"bar!\", baz: \"baz!\", foo: \"foo!\"}" }, 
            ],
            [
                "({foo: 123, bar: 456}, {baz: 789}) select ... ...",
                { result: "(bar: 456, foo: 123, baz: 789)" },
            ],
            [
                "nested.structA",
                { result: "\"nested/structA\"" },
            ],
            [
                "nested.structA.listB",
                { result: "(\"nested/structA/listB0\", \"nested/structA/listB1\", \"nested/structA/listB2\")" },
            ],
            [
                "nested.structA.listB[0].valueC",
                { result: "\"nested/structA/listB0/valueC\"" },
            ],
            [
                "nested.structA.listB[1].valueC",
                { result: "\"nested/structA/listB1/valueC\"" },
            ],
            [
                "nested.structA...",
                { result: "(structX: \"nested/structA/structX\", listX: (\"nested/structA/listX0\", \"nested/structA/listX1\", \"nested/structA/listX2\"), valueX: \"nested/structA/valueX\")" },
            ],
            [
                "nested.structA.listB[1]...",
                { result: "(structX: \"nested/structA/listB1/structX\", listX: (\"nested/structA/listB1/listX0\", \"nested/structA/listB1/listX1\", \"nested/structA/listB1/listX2\"), valueX: \"nested/structA/listB1/valueX\")" },
            ],
            [
                "serialize(undef)",
                { result: "\"undef\"" },
            ],
            [
                "deserialize('undef')",
                { result: "undef" },
            ],
            [
                "serialize(pi)",
                { result: "\"3.141592653589793\"" },
            ],
            [
                "deserialize('pi')",
                { result: "3.141592653589793" },
            ],
            [
                "serialize(abs)",
                { result: "\"abs\"" },
            ],
            [
                "deserialize('abs')",
                { result: "abs" },
            ],
            [
                "deserialize('abs(-123)')",
                { result: "unknown 🗨️ \"invalid non-constant serialized data: abs(-123)\"" },
            ],
            [
                "serialize(not_defined)",
                { result: "\"undef\"" },
            ],
            [
                "deserialize('not_defined')",
                { result: "unknown 🗨️ \"invalid non-constant serialized data: not_defined\"" },
            ],
            [
                "deserialize('')",
                { result: "unknown 🗨️ \"invalid serialized data: ❌\"" },
            ],
            [
                "deserialize('+-*/')",
                { result: "unknown 🗨️ \"invalid serialized data: +-❌*/\"" },
            ],
            [
                "getattr('Char1', 'HP')",
                { result: "\"15\"" },
            ],
            [
                "'Char1'.HP",
                { result: "\"15\"" },
            ],
            [
                "getattr('Char1', 'XX')",
                { result: "unknown 🗨️ \"Unknown attribute: XX\"" },
            ],
            [
                "'Char1'.XX",
                { result: "unknown 🗨️ \"Unknown attribute: XX\"" },
            ],
            [
                "'Char1'.XX & ''",
                { result: "\"\"" },
            ],
            [
                "isunknown(getattr('Char1', 'XX'))",
                { result: "true" },
            ],
            [
                "isunknown('Char1'.XX)",
                { result: "true" },
            ],
            [
                "async('background process', 999)",
                { yield: "\"background process\"" },
                { result: "999" },
            ],
            [
                "async('background process', 999) + 1",
                { yield: "\"background process\"" },
                { result: "1000" },
            ],
            [
                "--+-+-+-strlen('ookook')",
                { result: "-6" },
            ],
            [
                "strlen(1 + 10 + 90)",
                { result: "3" },
            ],
            [
                "structABC.propA & structABC.propB",
                { result: "\"A!B!\"" },
            ],
            [
                "structABC.('prop' & 'A')",
                { result: "\"A!\"" },
            ],
            [
                "structABC.unknownProp",
                { result: "undef" },
            ],
            [
                "noStruct.someProp",
                { result: "unknown 🗨️ \"Unknown attribute: someProp\"" },
            ],
            [
                "'literal string'.someProp",
                { result: "unknown 🗨️ \"Unknown attribute: someProp\"" },
            ],
            [
                "...",
                { result: "\"anonymous!\"" },
            ],
            [
                "... eq 'anonymous!'",
                { result: "true" },
            ],
            [
                "'<' & ... & '>'",
                { result: "\"<anonymous!>\"" },
            ],
            [
                "'<' & ...upper & '>'",
                { result: "\"<ANONYMOUS!>\"" },
            ],
            [
                "...HP",
                { result: "\"15\"" },
            ],
            [
                "...HP + 1",
                { result: "16" },
            ],
            [
                "...HP == 15",
                { result: "true" },
            ],
            [
                "...('H' & 'P')",
                { result: "\"15\"" },
            ],
            [
                "6+++++7",
                { result: "13" },
            ],
            [
                "6++-++7",
                { result: "-1" },
            ],
            [
                "(((1)",
                { error: "During parse, expected binary operator, or colon (between property key and its value), or property lookup, or opening bracket (for array subscript), or three dots (to get list of property key-value pairs), or closing parenthesis in expression: (((1)❌" },
            ],
            [
                "(((1))",
                { error: "During parse, expected binary operator, or colon (between property key and its value), or property lookup, or opening bracket (for array subscript), or three dots (to get list of property key-value pairs), or closing parenthesis in expression: (((1))❌" },
            ],
            [
                "(((1)))",
                { result: "1" },
            ],
            [
                "(((1))))",
                { error: "During parse, expected binary operator, or colon (between property key and its value), or property lookup, or opening bracket (for array subscript), or three dots (to get list of property key-value pairs), or end of expression in expression: (((1)))❌)" },
            ],
            [
                "(((1)))]",
                { error: "During parse, expected binary operator, or colon (between property key and its value), or property lookup, or opening bracket (for array subscript), or three dots (to get list of property key-value pairs), or end of expression in expression: (((1)))❌]" },
            ],
            [
                "(3 + (2 + (1) *",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: (3 + (2 + (1) *❌" },
            ],
            [
                "(1 + 2 * 3 + 4 ** 5) - foo / bar + (6 + 7, (8 + 9) * 10 - strlen('foo \\'bar\\' baz \\\\quux'))",
                { result: "1181.7302631578948" },
            ],
            [
                "(1 + 2 * 3 + 4 ** 5) - foo! / bar(6 + 7, (8 + 9) * 10)",
                { error: "During parse, syntax error in expression: (1 + 2 * 3 + 4 ** 5) - foo❌! / bar(6 + 7, (8 + 9) * 10)" },
            ],
            [
                "(1 + 2 * 3 + 4 ** 5) - foo / bar(6 + 7)",
                { error: "During evaluate, invalid function in expression: (1 + 2 * 3 + 4 ** 5) - foo / bar❌(6 + 7)" },
            ],
            [
                "(1 + 2 * 3 + 4 ** 5) - foo / quux(6 + 7)",
                { error: "During evaluate, unknown function in expression: (1 + 2 * 3 + 4 ** 5) - foo / quux❌(6 + 7)" },
            ],
            [
                ") + 123",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: ❌) + 123" },
            ],
            [
                "* 456",
                { error: "During parse, expected unary operator, or debug operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: ❌* 456" },
            ],
            [
                "1 + ?",
                { error: "During parse, expected unary operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: 1 + ?❌" },
            ],
            [
                "1 + ? ? 2",
                { error: "During parse, expected unary operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: 1 + ? ❌? 2" },
            ],
            [
                "1 + ???? 2",
                { error: "During parse, expected unary operator, or literal value, or property key (followed by a colon), or variable or function name, or anonymous variable, or opening parenthesis (for expression grouping), or opening brace (for struct definition) in expression: 1 + ???❌? 2" },
            ],
            [
                "1 + ? 2 * 3 + 4",
                { debug: "❰2❱ ← 1 + ? ❰2❱ * 3 + 4" },
                { result: "11" },
            ],
            [
                "1 + ?? 2 * 3 + 4",
                { debug: "❰6❱ ← 1 + ?? ❰2 * 3❱ + 4" },
                { result: "11" },
            ],
            [
                "1 + ??? 2 * 3 + 4",
                { debug: "❰6❱ ← 1 + ??? ❰2 * 3❱ + 4" },
                { result: "11" },
            ],
            [
                "1 + ?(2 * 3) + 4",
                { debug: "❰6❱ ← 1 + ?❰(2 * 3)❱ + 4" },
                { result: "11" },
            ],
            [
                "1 + ?((2 * 3)) + 4",
                { debug: "❰6❱ ← 1 + ?❰((2 * 3))❱ + 4" },
                { result: "11" },
            ],
            [
                "1 + ?(2 * 3 + 4)",
                { debug: "❰10❱ ← 1 + ?❰(2 * 3 + 4)❱" },
                { result: "11" },
            ],
            [
                "1 + ?((2 * 3 + 4))",
                { debug: "❰10❱ ← 1 + ?❰((2 * 3 + 4))❱" },
                { result: "11" },
            ],
            [
                "1 + ?(2 * 3 + ? 4)",
                { debug: "❰4❱ ← 1 + ?(2 * 3 + ? ❰4❱)" },
                { debug: "❰10❱ ← 1 + ?❰(2 * 3 + ? 4)❱" },
                { result: "11" },
            ],
            [
                "1 + ?getattr('Dummy', 'HP')",
                { debug: "❰\"15\"❱ ← 1 + ?❰getattr('Dummy', 'HP')❱" },
                { result: "16" },
            ],
            [
                "?('foo' & 123 & 'bar')",
                { debug: "❰\"foo123bar\"❱ ← ?❰('foo' & 123 & 'bar')❱" },
                { result: "\"foo123bar\"" },
            ],
            [
                "1 + ? 2**3 * 4 <= 5",
                { debug: "❰2❱ ← 1 + ? ❰2❱**3 * 4 <= 5" },
                { result: "false" },
            ],
            [
                "1 + ?? 2**3 * 4 <= 5",
                { debug: "❰32❱ ← 1 + ?? ❰2**3 * 4❱ <= 5" },
                { result: "false" },
            ],
            [
                "1 + ??? 2**3 * 4 <= 5",
                { debug: "❰32❱ ← 1 + ??? ❰2**3 * 4❱ <= 5" },
                { result: "false" },
            ],
            [
                "? 2**3 * 4 <= 5",
                { debug: "❰2❱ ← ? ❰2❱**3 * 4 <= 5" },
                { result: "false" },
            ],
            [
                "?? 2**3 * 4 <= 5",
                { debug: "❰32❱ ← ?? ❰2**3 * 4❱ <= 5" },
                { result: "false" },
            ],
            [
                "??? 2**3 * 4 <= 5",
                { debug: "❰false❱ ← ??? ❰2**3 * 4 <= 5❱" },
                { result: "false" },
            ],
            [
                "(? 'Char1'.HP < 20)",
                { debug: "❰\"Char1\"❱ ← (? ❰'Char1'❱.HP < 20)" },
                { result: "true" },
            ],
            [
                "(?? 'Char1'.HP < 20)",
                { debug: "❰\"15\"❱ ← (?? ❰'Char1'.HP❱ < 20)" },
                { result: "true" },
            ],
            [
                "(??? 'Char1'.HP < 20)",
                { debug: "❰true❱ ← (??? ❰'Char1'.HP < 20❱)" },
                { result: "true" },
            ],
            [
                "? default + 123",
                { debug: "❰default❱ ← ? ❰default❱ + 123" },
                { result: "123" },
            ],
            [
                "? denied + 123",
                { debug: "❰denied❱ ← ? ❰denied❱ + 123" },
                { result: "123" },
            ],
            [
                "? unknown + 123",
                { debug: "❰unknown❱ ← ? ❰unknown❱ + 123" },
                { result: "123" },
            ],
            [
                "true",
                { result: "true" },
            ],
            [
                "false",
                { result: "false" },
            ],
            [
                "11 % 8",
                { result: "3" },
            ],
            [
                "-11 % 8",
                { result: "5" },
            ],
            [
                "11 % -8",
                { result: "-5" },
            ],
            [
                "-11 % -8",
                { result: "-3" },
            ],
            [
                "min()",
                { result: "undef" },
            ],
            [
                "min(+123, undef)",
                { result: "123" },
            ],
            [
                "min(-456, undef)",
                { result: "-456" },
            ],
            [
                "min(5, undefined, 'moo', 999, 2, -3.14)",
                { result: "-3.14" },
            ],
            [
                "max()",
                { result: "undef" },
            ],
            [
                "max(5, undefined, 'moo', 999, 2, -3.14)",
                { result: "999" },
            ],
            [
                "floor(-1.2)",
                { result: "-2" },
            ],
            [
                "floor(-1.5)",
                { result: "-2" },
            ],
            [
                "floor(-1.7)",
                { result: "-2" },
            ],
            [
                "floor(1.2)",
                { result: "1" },
            ],
            [
                "floor(1.5)",
                { result: "1" },
            ],
            [
                "floor(1.7)",
                { result: "1" },
            ],
            [
                "round(-1.2)",
                { result: "-1" },
            ],
            [
                "round(-1.5)",
                { result: "-1" },
            ],
            [
                "round(-1.7)",
                { result: "-2" },
            ],
            [
                "round(1.2)",
                { result: "1" },
            ],
            [
                "round(1.5)",
                { result: "2" },
            ],
            [
                "round(1.7)",
                { result: "2" },
            ],
            [
                "ceil(-1.2)",
                { result: "-1" },
            ],
            [
                "ceil(-1.5)",
                { result: "-1" },
            ],
            [
                "ceil(-1.7)",
                { result: "-1" },
            ],
            [
                "ceil(1.2)",
                { result: "2" },
            ],
            [
                "ceil(1.5)",
                { result: "2" },
            ],
            [
                "ceil(1.7)",
                { result: "2" },
            ],
            [
                "abs(-1.5)",
                { result: "1.5" },
            ],
            [
                "abs(1.5)",
                { result: "1.5" },
            ],
        ];

        let outputs = [];

        MychScriptContext.prototype.strlen = function(value)
        {
            return MychExpression.coerceString(value).length;
        }

        MychScriptContext.prototype.args = function(...values)
        {
            return values.map((value, index) => new MychExpressionStructItem("arg" + index, value));
        }

        MychScriptContext.prototype.argnum = function(...args)
        {
            return args.length;
        }

        MychScriptContext.prototype.arg0 = function(...args)
        {
            return args[0];
        }

        MychScriptContext.prototype.arg1 = function(...args)
        {
            return args[1];
        }

        MychScriptContext.prototype.arg2 = function(...args)
        {
            return args[2];
        }

        MychScriptContext.prototype.listnum = function(list)
        {
            if (list instanceof MychExpressionArgs)
            {
                console.log("Require list, got", list);
                return new MychScriptContext.Unknown("Require list, got args");
            }

            if (Array.isArray(list))
            {
                return list.length;
            }
            
            console.log("Require list, got", list);
            return new MychScriptContext.Unknown("Require list, got " + typeof(list));
        }

        MychScriptContext.prototype.getattr = function(characterName, attributeName)
        {
            switch (attributeName)
            {
                case "HP":
                    return "15";
                case "upper":
                    return MychExpression.coerceString(characterName).toUpperCase();
                case "lower":
                    return MychExpression.coerceString(characterName).toLowerCase();
            }

            return new MychScriptContext.Unknown("Unknown attribute: " + attributeName);
        }

        MychScriptContext.prototype.async = function*(intermediate, result)
        {
            yield intermediate;
            return result;
        }

        MychScriptContext.prototype.$debugSendExpression = function(result, source, resultSourceBegin = 0, resultSourceEnd = source.length)
        {
            let markedSourceBefore = source.substring(0, resultSourceBegin);
            let markedSourceBetween = source.substring(resultSourceBegin, resultSourceEnd);
            let markedSourceAfter = source.substring(resultSourceEnd);

            let debugResult = "\u2770" + MychExpression.literal(result) + "\u2771";
            let debugSource = markedSourceBefore + "\u2770" + markedSourceBetween + "\u2771" + markedSourceAfter;

            outputs.push(
            {
                type: "debug",
                text: debugResult + " \u2190 " + debugSource,
            });
        }

        let variables = new MychScriptVariables();

        class RecursiveStruct
        {
            constructor(path)
            {
                this.path = path;
            }

            toScalar()
            {
                return this.path;
            }

            $getProperty(key)
            {
                let nestedPath = this.path + "/" + key;

                if (key.startsWith("struct"))
                {
                    return new RecursiveStruct(nestedPath);
                }

                if (key.startsWith("list"))
                {
                    return [
                        new RecursiveStruct(nestedPath + "0"),
                        new RecursiveStruct(nestedPath + "1"),
                        new RecursiveStruct(nestedPath + "2")];
                }

                return nestedPath;
            }

            $getPropertyKeys()
            {
                return [
                    "structX",
                    "listX",
                    "valueX"];
            }
        }

        Object.assign(variables,
        {
            foo: 123,
            bar: 456,
            
            "...": "anonymous!",

            list12: [1, 2],
            list345: [3, 4, 5],

            structABC:
            {
                $getProperty: function(key) { return this[key] },

                propA: "A!",
                propB: "B!",
                propC: "C!",
            },

            nested: new RecursiveStruct("nested"),
        });

        function getResultRepresentation(context, result)
        {
            let originalToLiteral = MychScriptContext.DiagnosticUndef.prototype.toLiteral;

            try
            {
                MychScriptContext.DiagnosticUndef.prototype.toLiteral = function()
                {
                    if (this.reason == undefined)
                    {
                        return this.label;
                    }
                    else
                    {
                        return this.label + " \u{1F5E8}\uFE0F " + MychExpression.literal(stripHTML(this.reason));
                    }
                };

                return MychExpression.literal(result);
            }
            finally
            {
                MychScriptContext.DiagnosticUndef.prototype.toLiteral = originalToLiteral;
            }
        }

        let numTestsRun = 0;
        let numTestsSuccessful = 0;
        let testsFailed = [];

        MychScriptContext.running = true;

        for (let expressionSourceIndex = 0; expressionSourceIndex < expressionSources.length; ++expressionSourceIndex)
        {
            if (includedExpressionSources.length > 0 && !includedExpressionSources.includes(expressionSourceIndex))
            {
                continue;
            }

            let testSuccessful = true;

            let expressionSource = expressionSources[expressionSourceIndex][0];
            let expectedOutputs = expressionSources[expressionSourceIndex].slice(1);
            
            document.write("<div class='expression' id='expression-" + expressionSourceIndex + "'>");
            document.write("<table>");
            document.write("<tr><td></td><td class='expression-header' colspan='5'>test expression " + expressionSourceIndex + "</td></tr>");

            document.write("<tr>");
            document.write("<td class='lineno'>source</td>")
            document.write("<td colspan='5'>" + escapeHTML(expressionSource) + "</td>");
            document.write("</tr>");

            let expression = new MychExpression();
            
            try
            {
                expression.parse(expressionSource, new MychScriptContext());

                let resultGenerator = expression.evaluate(variables);
                let resultContainer;

                while (!(resultContainer = resultGenerator.next()).done)
                {
                    outputs.push(
                    {
                        type: "yield",
                        text: getResultRepresentation(expression.context, resultContainer.value),
                    });
                }

                outputs.push(
                {
                    type: "result",
                    text: getResultRepresentation(expression.context, resultContainer.value),
                });

                if (expression.isConstant())
                {
                    let variableResult = resultContainer.value;
                    let constantResult = expression.evaluateConstant();

                    let variableResultRepresentation = getResultRepresentation(expression.context, variableResult);
                    let constantResultRepresentation = getResultRepresentation(expression.context, constantResult);

                    if (variableResultRepresentation != constantResultRepresentation)
                    {
                        console.log("result:", variableResult, "constant:", constantResult);
                        throw "Constant result not equal to variable result";
                    }
                }

                let serializedResult = expression.context.serialize(resultContainer.value);
                let deserializedResult = expression.context.deserialize(serializedResult);
                let reserializedResult = expression.context.serialize(deserializedResult);

                if (serializedResult != reserializedResult)
                {
                    console.log("unserialized result:", resultContainer.value);
                    console.log("serialized result:", serializedResult);
                    console.log("deserialized result:", deserializedResult);
                    console.log("reserialized result:", reserializedResult);

                    if (expression.context.isunknown(deserializedResult))
                    {
                        throw "Error deserializing serialized result: " + expression.context.getreason(deserializedResult);
                    }
                    else
                    {
                        throw "Serialized result not equal to re-serialized result";
                    }
                }

                let literalResult = MychExpression.literal(resultContainer.value);
                let literalResultWithMarkup = MychExpression.literalWithMarkup(resultContainer.value);
                let literalResultWithMarkupStripped = stripHTML(literalResultWithMarkup);

                if (literalResult != literalResultWithMarkupStripped)
                {
                    console.log("literal:", literalResult);
                    console.log("literal with markup:", literalResultWithMarkup);
                    console.log("literal with markup stripped:", literalResultWithMarkupStripped);

                    throw "Result literal with markup stripped not equivalent to plain literal: " +
                        JSON.stringify(literalResultWithMarkupStripped) + " vs " +
                        JSON.stringify(literalResult);
                }
            }
            catch (exception)
            {
                console.log(exception);

                outputs.push(
                {
                    type: "error",
                    text: String(exception),
                });
            }

            while (outputs.length > 0)
            {
                let output = outputs.shift();

                let expectedOutput = expectedOutputs.shift();
                let expectedOutputSatisfied = false;
                let expectedOutputType;
                let expectedOutputText;

                let receivedOutputType = output.type;
                let receivedOutputText = output.text;

                if (expectedOutput)
                {
                    [expectedOutputType, expectedOutputText] = Object.entries(expectedOutput)[0];
                    expectedOutputSatisfied = (receivedOutputType == expectedOutputType && receivedOutputText == expectedOutputText);
                }

                if (expectedOutputSatisfied)
                {
                    document.write("<tr class='ok'>");
                    document.write("<td class='lineno'>" + receivedOutputType + "</td>")
                    document.write("<td class='output " + receivedOutputType + "' colspan='5'>" + escapeHTML(receivedOutputText) + "</td>");
                    document.write("</tr>");
                }
                else
                {
                    testSuccessful = false;

                    document.write("<tr class='unexpected'>");
                    document.write("<td class='lineno'>" + receivedOutputType + "</td>")
                    document.write("<td class='output " + receivedOutputType + "' colspan='5'>" + escapeHTML(receivedOutputText) + "</td>");
                    document.write("</tr>");

                    console.log("received:", JSON.stringify({ [receivedOutputType]: receivedOutputText }));

                    if (expectedOutput)
                    {
                        document.write("<tr class='expected'>");
                        document.write("<td class='lineno'>" + expectedOutputType + "</td>")
                        document.write("<td class='output " + expectedOutputType + "' colspan='5'>" + escapeHTML(expectedOutputText) + "</td>");
                        document.write("</tr>");

                        console.log("expected:", JSON.stringify({ [expectedOutputType]: expectedOutputText }));
                    }
                }
            }

            for (let expectedOutput of expectedOutputs)
            {
                testSuccessful = false;

                [expectedOutputType, expectedOutputText] = Object.entries(expectedOutput)[0];

                document.write("<tr class='expected'>");
                document.write("<td class='lineno'>" + expectedOutputType + "</td>")
                document.write("<td class='output " + expectedOutputType + "' colspan='5'>" + escapeHTML(expectedOutputText) + "</td>");
                document.write("</tr>");

                console.log("expected:", JSON.stringify({ [expectedOutputType]: expectedOutputText }));
            }

            expectedOutputs.length = 0;

            let dependencyEntriesPerRow = expression.tokens.map(token => []);
            let numDependencyLevels = 0;
            let numDependencyEvaluators = 0;
            let numDependencyEvaluatorsToLevel = [0];

            if (expression.evaluator)
            {
                let evaluators = expression.evaluator.argEvaluators ? [expression.evaluator] : [];

                while (evaluators.length > 0)
                {
                    let nextEvaluators = [];

                    for (let evaluator of evaluators)
                    {
                        for (let argIndex = 0; argIndex < evaluator.argEvaluators.length; ++argIndex)
                        {
                            let argEvaluator = evaluator.argEvaluators[argIndex];

                            if (argEvaluator == undefined)
                            {
                                continue;
                            }

                            for (let tokenIndex = 0; tokenIndex < expression.tokens.length; ++tokenIndex)
                            {
                                let token = expression.tokens[tokenIndex];

                                if (token.offset < argEvaluator.sourceOffset || token.offset + token.length > argEvaluator.sourceOffset + argEvaluator.sourceLength)
                                {
                                    continue;
                                }

                                dependencyEntriesPerRow[tokenIndex][numDependencyLevels] =
                                {
                                    evaluatorIndex: numDependencyEvaluators,
                                    argIndex: argIndex,
                                    argEvaluator: argEvaluator,
                                };
                            }

                            nextEvaluators.push(argEvaluator);
                        }

                        numDependencyEvaluators += 1;
                    }

                    evaluators = nextEvaluators.filter(evaluator => evaluator.argEvaluators);

                    numDependencyLevels += 1;
                    numDependencyEvaluatorsToLevel[numDependencyLevels] = numDependencyEvaluators;
                }

                dependencyEntriesPerRow[dependencyEntriesPerRow.length - 1] = [];
            }

            document.write("<tr class='token-header'>");
            document.write("<td></td>")
            document.write("<td>token</td>");
            document.write("<td>type</td>");
            document.write("<td>rule</td>");
            document.write("<td>group</td>");

            if (numDependencyLevels == 0)
            {
                document.write("<td>evaluation</td>");
            }
            else
            {
                let colspan = numDependencyLevels;
                document.write("<td colspan='" + colspan + "'>evaluation</td>");
            }

            document.write("</tr>");

            for (let tokenIndex = 0; tokenIndex < expression.tokens.length; ++tokenIndex)
            {
                let token = expression.tokens[tokenIndex];

                document.write("<tr class='token'>");
                document.write("<td class='lineno'>" + tokenIndex + "</td>")
                document.write("<td class='token-source'>" + escapeHTML(expression.source.substr(token.offset, token.length)) + "</td>")
                document.write("<td class='token-type'>" + escapeHTML(token.type) + "</td>")
                document.write("<td class='rule-name'>" + escapeHTML(token.ruleName || "") + "</td>")
                document.write("<td class='group'>" + escapeHTML(token.prevCloseTokenIndex != undefined ? token.prevCloseTokenIndex : "") + "</td>")

                let dependencyEntriesForRow = dependencyEntriesPerRow[tokenIndex];

                if (dependencyEntriesForRow.length == 0)
                {
                    let colspan = numDependencyLevels;
                    document.write("<td colspan='" + colspan + "' class='evaluation'></td>");
                }
                else
                {
                    for (let dependencyLevel = 0; dependencyLevel < dependencyEntriesForRow.length; ++dependencyLevel)
                    {
                        let dependencyEntry = dependencyEntriesForRow[dependencyLevel];

                        let dependencyDescriptionOrder = 1 + (numDependencyEvaluators - numDependencyEvaluatorsToLevel[dependencyLevel + 1]) + dependencyEntry.evaluatorIndex - numDependencyEvaluatorsToLevel[dependencyLevel];
                        let dependencyDescriptionArgument = String.fromCharCode(dependencyEntry.argIndex + "A".charCodeAt(0));
                        let dependencyDescription = dependencyDescriptionOrder + dependencyDescriptionArgument;

                        let evaluationVariabilityClass = dependencyEntry.argEvaluator.isConstant ? "constant" : "variable";

                        if (dependencyLevel < dependencyEntriesForRow.length - 1)
                        {
                            document.write("<td class='evaluation " + evaluationVariabilityClass + "'>");
                        }
                        else
                        {
                            let colspan = numDependencyLevels - (dependencyEntriesForRow.length - 1);
                            document.write("<td class='evaluation " + evaluationVariabilityClass + "' colspan='" + colspan + "'>");
                        }

                        document.write(escapeHTML(dependencyDescription));
                        document.write("</td>");
                    }
                }

                document.write("</tr>");
            }

            document.write("</table>");
            document.write("</div>");

            numTestsRun += 1;
            numTestsSuccessful += (testSuccessful ? 1 : 0);

            if (!testSuccessful)
            {
                testsFailed.push(expressionSourceIndex);
            }
        }

        let tests = includedExpressionSources.length ? includedExpressionSources : [...Array(numTestsRun).keys()];
        let testsFailedAsSet = new Set(testsFailed);
        let testsSuccessful = tests.filter(index => !testsFailedAsSet.has(index));

        if (numTestsSuccessful == numTestsRun)
        {
            document.write("<div id='results' class='results-success'>");
            document.write("Success: Evaluated " + numTestsRun + " test expressions, all successful.");
            document.write("</div>");
        }
        else
        {
            document.write("<div id='results' class='results-failure'>");
            document.write("Failed: Evaluated " + numTestsRun + " test expressions, " + (numTestsRun - numTestsSuccessful) + " failed (expression index " + testsFailed.map(index => "<a href='#expression-" + index + "'>" + index + "</a>").join(", ") + ")");
            document.write("<br>");
            document.write("<button id='show-successful-tests-button' onclick='showSuccessfulTests()'>Show all tests</button>");
            document.write("<button id='hide-successful-tests-button' onclick='hideSuccessfulTests()'>Show only failed tests</button>");
            document.write("</div>");

            hideSuccessfulTests();
        }

        document.getElementById("results-container").appendChild(document.getElementById("results"));

        function showSuccessfulTests()
        {
            for (testSuccessfulIndex of testsSuccessful)
            {
                document.getElementById("expression-" + testSuccessfulIndex).style = "display: auto";
            }

            document.getElementById("show-successful-tests-button").style = "display: none";
            document.getElementById("hide-successful-tests-button").style = "display: auto";
        }

        function hideSuccessfulTests()
        {
            for (testSuccessfulIndex of testsSuccessful)
            {
                document.getElementById("expression-" + testSuccessfulIndex).style = "display: none";
            }

            document.getElementById("show-successful-tests-button").style = "display: auto";
            document.getElementById("hide-successful-tests-button").style = "display: none";
        }
    </script>
</body>
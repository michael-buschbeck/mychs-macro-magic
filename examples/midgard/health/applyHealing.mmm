!rem // applyHealing applies both healing and energy boosts (or either)
!rem //
%{MacroSheetLibrary|libMidgardFunctions}
!mmm script
!mmm   set scriptVersion = "applyHealing 1.1.0 (2022-01-16)"
!mmm
!mmm   set customizable cCheckVersion = false
!mmm   if cCheckVersion
!mmm     do whisperback(scriptVersion)
!mmm     exit script
!mmm   end if
!mmm
%{MacroSheetLibrary|libMidgardGlobal}
!mmm
!mmm   if selected and sender.token_id ne selected
!mmm     set customizable cOwnID = selected.token_id
!mmm     set customizable cHealthAttr = "bar3"
!mmm     set customizable cEnduranceAttr = "bar2"
!mmm     set user = "GM"
!mmm   else 
!mmm     set customizable cOwnID = sender.token_id
!mmm     set customizable cHealthAttr = "LP"
!mmm     set customizable cEnduranceAttr = "AP"
!mmm     set user = cOwnID.name
!mmm   end if
!mmm   
!mmm   set maxEnduranceGain = m3mgdExchange.(m3mgdAttrEnduranceGain)
!mmm   set maxHealthGain = m3mgdExchange.(m3mgdAttrHealthGain)
!mmm   
!mmm   if not (maxHealthGain > 0 or maxEnduranceGain > 0)
!mmm   
!mmm     chat: /w "${user}" [**Lebens-/Ausdauergewinn eingeben**](~MacroSheet|applyHealingDataEntry)
!mmm     exit script
!mmm
!mmm   end if 
!mmm
!mmm   set newHealth = m3mgdModifyHealth(maxHealthGain, cOwnID, cHealthAttr)
!mmm   
!mmm   set prvEndurance = cOwnID.(cEnduranceAttr)
!mmm   set newEndurance = m3mgdModifyEndurance(maxEnduranceGain, cOwnID, cEnduranceAttr)
!mmm   set effEnduranceGain = newEndurance - prvEndurance
!mmm   set enduranceHighlight = "normal"
!mmm   if effEnduranceGain < maxEnduranceGain
!mmm     set enduranceHighlight = "important"
!mmm     if newEndurance == cOwnID.(cEnduranceAttr).max
!mmm       set enduranceLog = "Auf AP.max begrenzt"
!mmm     else if newEndurance <= m3mgdAttrCeiling(cOwnID, cEnduranceAttr)
!mmm       set enduranceLog = "Auf " & m3mgdAttrCeiling(cOwnID, cEnduranceAttr) & " begrenzt"
!mmm     else 
!mmm       set enduranceLog = "Fehler? Grund fÃ¼r reduzierten AP-Gewinn unbekannt"
!mmm     end if
!mmm   end if
!mmm
!mmm   if newHealth <= 0 and timeToDie == undef
!mmm     set timeToDie = "(unbekannt)"
!mmm   end if
!mmm
!mmm   combine chat
!mmm     
!mmm     chat: /w "${cOwnID.name}" ${"&"}{template:default} {{name=${m3mgdShapeMoji(cOwnID, cHealthAttr, cEnduranceAttr) & cOwnID.name}: Heil-/Ausdauereffekte}} 
!mmm     
!mmm     chat: {{Heileffekt=${highlight("+" & maxHealthGain, "normal")} **=>** ${newHealth} **LP**}}
!mmm
!mmm     chat: {{Ausdauereffekt=${highlight("+" & effEnduranceGain & "/" & maxEnduranceGain, enduranceHighlight, enduranceLog)} **=>** ${newEndurance} **AP**}}
!mmm     
!mmm     if newHealth < 0 and timeToDie < 0
!mmm     
!mmm       chat: {{Zustand=**Sofortiger Tod &#10013;**}}
!mmm     
!mmm     else
!mmm     
!mmm       chat: {{${m3mgdHealthStatusLabel(cOwnID, cHealthAttr)}=${m3mgdHealthStatusEffectsDesc(cOwnID, cHealthAttr)}}}
!mmm       chat: {{${m3mgdEnduranceStatusLabel(cOwnID, cEnduranceAttr)}=${m3mgdEnduranceStatusEffectsDesc(cOwnID, cEnduranceAttr)}}}
!mmm     
!mmm     end if
!mmm     
!mmm   end combine
!mmm
!mmm end script